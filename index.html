<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>For Lifters Only</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Theme Colors -->
    <meta name="theme-color" content="#1f2937">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- iOS Specific -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="For Lifters Only">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <!-- App Description -->
    <meta name="description" content="Track your gym workouts with equipment-based exercise selection">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html {
            overflow-x: hidden;
            width: 100%;
        }
        
        html, body, div, span, p, h1, h2, h3, h4, h5, h6 {
            max-width: 100%;
            overflow-wrap: break-word;
            word-wrap: break-word;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
            color: white;
            min-height: 100vh;
            padding: 8px;
            padding-bottom: 70px;
            line-height: 1.3;
            font-size: 13px;
            overflow-x: hidden;
            width: 100%;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
            overflow-x: hidden;
        }

        .header h1 {
            font-size: 1.75rem;
            font-weight: 800;
            background: linear-gradient(45deg, #10b981, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            margin-bottom: 10px;
        }

        .week-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 10px;
            text-align: center;
            backdrop-filter: blur(10px);
            font-size: 12px;
        }

        .workout-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow-x: hidden;
            width: 100%;
            max-width: 100%;
        }

        .nav-buttons {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            font-size: 13px;
            min-height: 36px;
        }

        .nav-btn.active {
            background: linear-gradient(45deg, #3b82f6, #2563eb);
            border-color: #3b82f6;
        }

        .hidden {
            display: none !important;
        }

        .action-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            min-height: 44px;
        }

        .action-btn.success {
            border-color: #10b981;
            color: #6ee7b7;
        }

        .action-btn.danger {
            border-color: #ef4444;
            color: #fecaca;
        }

        .action-btn.primary {
            border-color: #3b82f6;
            color: #93c5fd;
        }

        .timer-toggle {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 36px;
            font-size: 13px;
        }

        .timer-content {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            backdrop-filter: blur(10px);
        }

        .timer-display {
            font-size: 2rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 8px;
            font-variant-numeric: tabular-nums;
        }

        .timer-display.warning { color: #f59e0b; }
        .timer-display.danger { color: #ef4444; }

        .timer-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            margin-bottom: 8px;
        }

        .timer-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 13px;
            min-height: 36px;
        }

        .timer-btn.start {
            background: linear-gradient(45deg, #10b981, #059669);
            border: none;
        }

        .timer-btn.stop {
            background: linear-gradient(45deg, #ef4444, #dc2626);
            border: none;
        }

        .time-presets {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .time-preset {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px 14px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            min-height: 44px;
            display: flex;
            align-items: center;
        }

        .time-preset.active {
            background: linear-gradient(45deg, #3b82f6, #2563eb);
            border-color: #3b82f6;
        }

        .workout-dropdown {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 12px;
            color: white;
            font-size: 16px;
            width: 100%;
            min-height: 48px;
        }

        .workout-dropdown option {
            background: #374151;
            color: white;
        }

        .quick-add {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 12px;
        }

        .search-bar {
            position: relative;
            margin-bottom: 10px;
        }

        .search-input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
            min-height: 48px;
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .search-results {
            max-height: 300px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .search-result {
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: background 0.2s;
        }

        .search-result:hover {
            background: rgba(16, 185, 129, 0.2);
        }

        .search-result:last-child {
            border-bottom: none;
        }

        .exercise-item {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }

        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            cursor: pointer;
            user-select: none;
        }

        .exercise-name {
            font-weight: 600;
            color: #10b981;
            font-size: 14px;
        }

        .exercise-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .icon-btn {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4);
            color: #fecaca;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .exercise-content {
            padding: 0 10px 10px;
        }

        .set-row {
            display: grid;
            grid-template-columns: 35px minmax(60px, 1fr) minmax(60px, 1fr) 30px;
            gap: 6px;
            align-items: center;
            margin-bottom: 6px;
        }

        .set-number {
            text-align: center;
            font-weight: 600;
            color: #10b981;
            font-size: 13px;
        }

        .exercise-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px;
            border-radius: 6px;
            font-size: 14px;
            text-align: center;
            min-height: 40px;
        }

        .exercise-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .set-btn {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.4);
            color: #6ee7b7;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .history-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .history-toggle {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            font-weight: 600;
            color: #93c5fd;
            margin-bottom: 8px;
        }

        .history-entry {
            font-size: 11px;
            padding: 6px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            margin-bottom: 4px;
        }

        .history-entry:last-child {
            margin-bottom: 0;
        }

        .muscle-checkbox-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .muscle-checkbox-label {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }

        .muscle-checkbox-label:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .muscle-checkbox {
            margin: 0;
        }

        .workout-summary {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 13px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #10b981;
        }

        .stat-label {
            font-size: 11px;
            opacity: 0.8;
        }

        @media (max-width: 480px) {
            body {
                font-size: 12px;
                padding: 4px;
            }
            
            .container {
                padding: 0;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .timer-display {
                font-size: 1.75rem;
            }
            
            .nav-btn {
                font-size: 11px;
                padding: 6px 8px;
            }
            
            .workout-card {
                padding: 6px;
            }
            
            /* Mobile-optimized set row layout - make inputs stretch to fill */
            .set-row {
                grid-template-columns: 24px minmax(50px, 1fr) minmax(50px, 1fr) 24px;
                gap: 4px;
            }
            
            .set-number {
                font-size: 11px;
            }
            
            .exercise-input {
                padding: 8px 4px;
                font-size: 13px;
                min-height: 36px;
                width: 100%;
            }
            
            .set-btn {
                width: 24px;
                height: 24px;
                font-size: 13px;
            }
            
            /* Ensure all divs and content stay within bounds */
            div, span, p {
                max-width: 100%;
                word-wrap: break-word;
                overflow-wrap: break-word;
            }
            
            /* Fix SVG scaling on mobile */
            svg {
                max-width: 100%;
                height: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>For Lifters Only</h1>
            <div class="week-info" id="weekInfo">Loading...</div>
        </div>

        <div class="nav-buttons">
            <button class="nav-btn active" onclick="showTab('workout')">Today's Workout</button>
            <button class="nav-btn" onclick="showTab('workouts')">Create Workouts</button>
            <button class="nav-btn" onclick="showTab('cardio')">Cardio</button>
            <button class="nav-btn" onclick="showTab('history')">History</button>
            <button class="nav-btn" onclick="showTab('progress')">Progress</button>
            <button class="nav-btn" onclick="showTab('settings')">Settings</button>
        </div>

        <!-- Workout Tab -->
        <div id="workoutTab">
            <!-- Rest Timer -->
            <div class="workout-card">
                <div class="timer-toggle" onclick="toggleTimer()">
                    <span>‚è±Ô∏è Rest Timer</span>
                    <span id="timerToggleIcon">‚ñº</span>
                </div>
                <div id="timerContent" class="timer-content hidden">
                    <div class="timer-display" id="timerDisplay">0:00</div>
                    <div class="timer-controls">
                        <button class="timer-btn" onclick="adjustTimer(-10)">-10s</button>
                        <button class="timer-btn start" id="startBtn" onclick="startTimer()">Start</button>
                        <button class="timer-btn" onclick="adjustTimer(10)">+10s</button>
                    </div>
                    <div style="margin-bottom: 8px;">
                        <button class="timer-btn" onclick="resetTimer()" style="width: 100%;">Reset</button>
                    </div>
                    <div class="time-presets">
                        <button class="time-preset" onclick="setTimer(60)">1:00</button>
                        <button class="time-preset" onclick="setTimer(90)">1:30</button>
                        <button class="time-preset" onclick="setTimer(120)">2:00</button>
                        <button class="time-preset" onclick="setTimer(180)">3:00</button>
                    </div>
                </div>
            </div>

            <!-- Start Workout Selection (shown when no workout active) -->
            <div id="workoutSelection" class="workout-card">
                <h3 style="color: #10b981; margin-bottom: 10px; font-size: 16px;">Start Workout</h3>
                <select class="workout-dropdown" id="workoutSelectStart">
                    <option value="">Select a workout to begin...</option>
                </select>
                <button class="action-btn success" onclick="startWorkoutSession()" style="width: 100%; margin-top: 10px;">
                    üöÄ Start Workout
                </button>
            </div>

            <!-- Active Workout Interface (shown after starting) -->
            <div id="activeWorkoutInterface" class="hidden">
                <!-- Current Workout Header -->
                <div class="workout-card" style="background: rgba(16, 185, 129, 0.15); border-color: rgba(16, 185, 129, 0.4);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 12px; opacity: 0.7;">Current Workout</div>
                            <div style="font-size: 16px; font-weight: 600; color: #10b981;" id="currentWorkoutName">-</div>
                        </div>
                        <button class="action-btn danger" onclick="endWorkoutSession()" style="padding: 6px 12px; min-height: 32px;">
                            End Workout
                        </button>
                    </div>
                </div>

                <!-- Workout Summary -->
                <div class="workout-summary" id="workoutSummary">
                    <div class="summary-stats">
                        <div>
                            <div class="stat-value" id="exerciseCount">0</div>
                            <div class="stat-label">Exercises</div>
                        </div>
                        <div>
                            <div class="stat-value" id="setCount">0</div>
                            <div class="stat-label">Sets</div>
                        </div>
                        <div>
                            <div class="stat-value" id="volumeCount">0</div>
                            <div class="stat-label">Volume (lbs)</div>
                        </div>
                    </div>
                </div>

                <!-- Exercise List -->
                <div id="exerciseList"></div>

                <!-- Quick Add Exercise -->
                <div class="workout-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <h3 style="color: #10b981; margin: 0; font-size: 14px;">‚ûï Add Exercise</h3>
                        <button class="action-btn primary" onclick="showCustomExerciseManager()" style="padding: 6px 10px; font-size: 12px; min-height: 32px;">
                            Manage Custom
                        </button>
                    </div>
                    <div class="search-bar">
                        <input type="text" 
                               class="search-input" 
                               id="exerciseSearch" 
                               placeholder="Search exercises..."
                               oninput="searchExercises()">
                    </div>
                    <div id="searchResults" class="search-results hidden"></div>
                    <button class="action-btn success" onclick="showCreateCustomExercise()" style="width: 100%; margin-top: 8px;">
                        + Create Custom Exercise
                    </button>
                </div>

                <!-- Finish Workout -->
                <div class="workout-card">
                    <button class="action-btn success" onclick="finishWorkout()" style="width: 100%;">
                        ‚úì Finish Workout
                    </button>
                </div>
            </div>
        </div>

        <!-- Workouts Tab -->
        <div id="workoutsTab" class="hidden">
            <div class="workout-card">
                <button class="action-btn primary" id="createWorkoutBtn" onclick="showWorkoutForm()" style="width: 100%;">
                    + Create Workout
                </button>
                
                <div id="workoutForm" class="hidden">
                    <h3 style="color: #10b981; margin-bottom: 8px;">Create Workout</h3>
                    <input type="text" id="workoutName" placeholder="Workout name..." class="search-input" style="margin-bottom: 10px;">
                    
                    <h4 style="margin: 10px 0 8px; font-size: 13px;">Select Muscle Groups:</h4>
                    <div class="muscle-checkbox-container">
                        <label class="muscle-checkbox-label">
                            <input type="checkbox" class="muscle-checkbox" value="Chest">
                            <span>Chest</span>
                        </label>
                        <label class="muscle-checkbox-label">
                            <input type="checkbox" class="muscle-checkbox" value="Back">
                            <span>Back</span>
                        </label>
                        <label class="muscle-checkbox-label">
                            <input type="checkbox" class="muscle-checkbox" value="Shoulders">
                            <span>Shoulders</span>
                        </label>
                        <label class="muscle-checkbox-label">
                            <input type="checkbox" class="muscle-checkbox" value="Rear Delts">
                            <span>Rear Delts</span>
                        </label>
                        <label class="muscle-checkbox-label">
                            <input type="checkbox" class="muscle-checkbox" value="Biceps">
                            <span>Biceps</span>
                        </label>
                        <label class="muscle-checkbox-label">
                            <input type="checkbox" class="muscle-checkbox" value="Triceps">
                            <span>Triceps</span>
                        </label>
                        <label class="muscle-checkbox-label">
                            <input type="checkbox" class="muscle-checkbox" value="Quads">
                            <span>Quads</span>
                        </label>
                        <label class="muscle-checkbox-label">
                            <input type="checkbox" class="muscle-checkbox" value="Hamstrings">
                            <span>Hamstrings</span>
                        </label>
                        <label class="muscle-checkbox-label">
                            <input type="checkbox" class="muscle-checkbox" value="Glutes">
                            <span>Glutes</span>
                        </label>
                        <label class="muscle-checkbox-label">
                            <input type="checkbox" class="muscle-checkbox" value="Calves">
                            <span>Calves</span>
                        </label>
                        <label class="muscle-checkbox-label">
                            <input type="checkbox" class="muscle-checkbox" value="Core">
                            <span>Core</span>
                        </label>
                    </div>
                    
                    <div style="display: flex; gap: 8px;">
                        <button class="action-btn success" onclick="saveWorkout()" style="flex: 1;">Save</button>
                        <button class="action-btn danger" onclick="hideWorkoutForm()" style="flex: 1;">Cancel</button>
                    </div>
                </div>
                
                <div id="workoutsList"></div>
            </div>
        </div>

        <!-- Cardio Tab -->
        <div id="cardioTab" class="hidden">
            <div class="workout-card">
                <h3 style="color: #10b981; margin-bottom: 15px;">Log Cardio Session</h3>
                
                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 5px; font-size: 13px;">Exercise Type:</label>
                    <select id="cardioType" class="workout-dropdown">
                        <option value="">Select type...</option>
                        <option value="Running">Running</option>
                        <option value="Cycling">Cycling</option>
                        <option value="Rowing">Rowing</option>
                        <option value="Elliptical">Elliptical</option>
                        <option value="Stair Climber">Stair Climber</option>
                        <option value="Swimming">Swimming</option>
                        <option value="Walking">Walking</option>
                        <option value="Jump Rope">Jump Rope</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-size: 13px;">Duration (minutes):</label>
                        <input type="number" id="cardioDuration" class="workout-dropdown" placeholder="30" style="width: 100%;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-size: 13px;">Distance (miles):</label>
                        <input type="number" id="cardioDistance" class="workout-dropdown" placeholder="3.5" step="0.1" style="width: 100%;">
                    </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-size: 13px;">Calories (optional):</label>
                    <input type="number" id="cardioCalories" class="workout-dropdown" placeholder="250" style="width: 100%;">
                </div>
                
                <button class="action-btn success" onclick="saveCardioSession()" style="width: 100%;">
                    Save Cardio Session
                </button>
            </div>
            
            <div class="workout-card">
                <h3 style="color: #10b981; margin-bottom: 10px;">Cardio History</h3>
                <div id="cardioHistoryContent"></div>
            </div>
        </div>

        <!-- History Tab -->
        <div id="historyTab" class="hidden">
            <!-- Streak Stats Card -->
            <div class="workout-card" style="margin-bottom: 15px;">
                <h3 style="color: #10b981; margin-bottom: 15px; text-align: center;">Your Stats</h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                    <div style="text-align: center; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px;">
                        <div style="font-size: 2rem; font-weight: bold; color: #f59e0b;" id="currentStreak">0</div>
                        <div style="font-size: 0.75rem; opacity: 0.6; margin-top: 2px;" id="bestStreakMonthSub">(Best: 0)</div>
                        <div style="font-size: 0.9rem; opacity: 0.8; margin-top: 4px;">Day Streak</div>
                    </div>
                    <div style="text-align: center; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px;">
                        <div style="font-size: 2rem; font-weight: bold; color: #f59e0b;" id="daysThisWeek">0</div>
                        <div style="font-size: 0.9rem; opacity: 0.8; margin-top: 8px;">Days This Week</div>
                    </div>
                    <div style="text-align: center; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px;">
                        <div style="font-size: 2rem; font-weight: bold; color: #f59e0b;" id="daysThisMonth">0</div>
                        <div style="font-size: 0.9rem; opacity: 0.8; margin-top: 8px;">Days This Month</div>
                    </div>
                </div>
            </div>
            
            <div class="workout-card">
                <h3 style="color: #10b981; margin-bottom: 10px;">Workout History</h3>
                <div id="historyContent"></div>
            </div>
        </div>

        <!-- Progress Tab -->
        <div id="progressTab" class="hidden">
            <div class="workout-card">
                <h3 style="color: #10b981; margin-bottom: 10px;">Progress Tracking</h3>
                <div id="progressContent"></div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settingsTab" class="hidden">
            <div class="workout-card">
                <div id="settingsContent"></div>
            </div>
        </div>
        
        <!-- Custom Exercise Modal -->
        <div id="customExerciseModal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; padding: 20px; overflow-y: auto;">
            <div style="max-width: 600px; margin: 0 auto; background: linear-gradient(135deg, #1f2937 0%, #374151 100%); border-radius: 10px; padding: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 style="color: #10b981; margin: 0;">Custom Exercises</h2>
                    <button class="icon-btn" onclick="hideCustomExerciseManager()" style="width: 36px; height: 36px; font-size: 24px;">√ó</button>
                </div>
                
                <!-- Create/Edit Form -->
                <div id="customExerciseForm" class="hidden" style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h3 style="color: #10b981; margin-bottom: 10px; font-size: 16px;" id="customFormTitle">Create Custom Exercise</h3>
                    
                    <div style="position: relative; margin-bottom: 10px;">
                        <input type="text" id="customExerciseName" placeholder="Exercise name..." class="search-input" 
                               style="margin-bottom: 0;" oninput="filterExerciseNames()" onfocus="showExerciseNameDropdown()" autocomplete="off">
                        <div id="exerciseNameDropdown" class="search-results hidden" style="position: absolute; top: 100%; left: 0; right: 0; max-height: 200px; overflow-y: auto; background: rgba(31, 41, 55, 0.98); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; margin-top: 4px; z-index: 100;"></div>
                    </div>
                    
                    <div style="position: relative; margin-bottom: 10px;">
                        <input type="text" id="customExerciseEquipment" placeholder="Search or type equipment..." class="search-input" 
                               style="margin-bottom: 0;" oninput="filterEquipmentOptions()" onfocus="showEquipmentDropdown()" autocomplete="off">
                        <div id="equipmentDropdown" class="search-results hidden" style="position: absolute; top: 100%; left: 0; right: 0; max-height: 200px; overflow-y: auto; background: rgba(31, 41, 55, 0.98); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; margin-top: 4px; z-index: 100;"></div>
                    </div>
                    
                    <textarea id="customExerciseDescription" placeholder="Description (optional)..." class="search-input" style="min-height: 80px; resize: vertical; margin-bottom: 10px;"></textarea>
                    
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 13px;">Muscle Groups:</label>
                        <div class="muscle-checkbox-container">
                            <label class="muscle-checkbox-label">
                                <input type="checkbox" class="custom-muscle-checkbox" value="Chest">
                                <span>Chest</span>
                            </label>
                            <label class="muscle-checkbox-label">
                                <input type="checkbox" class="custom-muscle-checkbox" value="Back">
                                <span>Back</span>
                            </label>
                            <label class="muscle-checkbox-label">
                                <input type="checkbox" class="custom-muscle-checkbox" value="Shoulders">
                                <span>Shoulders</span>
                            </label>
                            <label class="muscle-checkbox-label">
                                <input type="checkbox" class="custom-muscle-checkbox" value="Rear Delts">
                                <span>Rear Delts</span>
                            </label>
                            <label class="muscle-checkbox-label">
                                <input type="checkbox" class="custom-muscle-checkbox" value="Biceps">
                                <span>Biceps</span>
                            </label>
                            <label class="muscle-checkbox-label">
                                <input type="checkbox" class="custom-muscle-checkbox" value="Triceps">
                                <span>Triceps</span>
                            </label>
                            <label class="muscle-checkbox-label">
                                <input type="checkbox" class="custom-muscle-checkbox" value="Quads">
                                <span>Quads</span>
                            </label>
                            <label class="muscle-checkbox-label">
                                <input type="checkbox" class="custom-muscle-checkbox" value="Hamstrings">
                                <span>Hamstrings</span>
                            </label>
                            <label class="muscle-checkbox-label">
                                <input type="checkbox" class="custom-muscle-checkbox" value="Glutes">
                                <span>Glutes</span>
                            </label>
                            <label class="muscle-checkbox-label">
                                <input type="checkbox" class="custom-muscle-checkbox" value="Calves">
                                <span>Calves</span>
                            </label>
                            <label class="muscle-checkbox-label">
                                <input type="checkbox" class="custom-muscle-checkbox" value="Core">
                                <span>Core</span>
                            </label>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 13px;">Difficulty:</label>
                        <select id="customExerciseDifficulty" class="workout-dropdown" style="margin-bottom: 0;">
                            <option value="beginner">Beginner</option>
                            <option value="intermediate">Intermediate</option>
                            <option value="advanced">Advanced</option>
                        </select>
                    </div>
                    
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px; cursor: pointer;">
                        <input type="checkbox" id="customExerciseIsBodyweight">
                        <span style="font-size: 13px;">This is a bodyweight exercise</span>
                    </label>
                    
                    <div style="display: flex; gap: 8px;">
                        <button class="action-btn success" onclick="saveCustomExercise()" style="flex: 1;">Save</button>
                        <button class="action-btn danger" onclick="cancelCustomExerciseForm()" style="flex: 1;">Cancel</button>
                    </div>
                </div>
                
                <!-- List of Custom Exercises -->
                <div id="customExercisesList"></div>
                
                <button class="action-btn success" onclick="showCreateCustomExercise()" style="width: 100%; margin-top: 10px;">
                    + Create New Exercise
                </button>
            </div>
        </div>
    </div>

    <script>
(function() {
    'use strict';
    
    // Global state
    let appData = { workouts: {}, history: {}, settings: {}, activeWorkout: {}, customExercises: {}, cardio: {} };
    let exerciseDB = {};
    let equipmentDB = {};
    let activeExercises = [];
    let currentWorkoutId = null;
    let editingWorkoutId = null;
    let workoutStartTime = null;
    
    // Timer state
    let timeRemaining = 90;
    let timerInterval = null;
    let timerRunning = false;
    
    // Inactivity notification state
    let inactivityTimer = null;
    let notificationPermissionGranted = false;
    let lastActivityTime = Date.now();
    let lastVisibilityTime = Date.now();
    const INACTIVITY_TIMEOUT = 30 * 60 * 1000; // 30 minutes in milliseconds
    
    // Storage
    function saveData() {
        localStorage.setItem('jimTrackerData', JSON.stringify(appData));
    }
    
    function loadData() {
        const saved = localStorage.getItem('jimTrackerData');
        if (saved) {
            appData = JSON.parse(saved);
            // Ensure customExercises exists
            if (!appData.customExercises) {
                appData.customExercises = {};
            }
        }
    }
    
    function saveActiveWorkout() {
        appData.activeWorkout = {
            workoutId: currentWorkoutId,
            exercises: activeExercises
        };
        saveData();
    }
    
    function loadActiveWorkout() {
        if (appData.activeWorkout && appData.activeWorkout.exercises) {
            activeExercises = appData.activeWorkout.exercises;
            currentWorkoutId = appData.activeWorkout.workoutId;
            
            if (currentWorkoutId && appData.workouts[currentWorkoutId]) {
                document.getElementById('currentWorkoutName').textContent = appData.workouts[currentWorkoutId].name;
            }
        }
    }
    
    // Database loading
    async function loadDatabases() {
        // Load exercises from external JSON file
        try {
            const response = await fetch('https://raw.githubusercontent.com/CJWiebe/for-lifters-only/main/exercises.json');
            if (!response.ok) {
                throw new Error('Failed to load exercises database');
            }
            const data = await response.json();
            
            // Process the exercises to ensure compatibility
            exerciseDB = {};
            for (const [name, exercise] of Object.entries(data)) {
                // Ensure muscleGroups array exists (some exercises might only have muscleGroup)
                if (!exercise.muscleGroups && exercise.muscleGroup) {
                    exercise.muscleGroups = [exercise.muscleGroup];
                }
                
                // Ensure equipmentVariations array exists
                if (!exercise.equipmentVariations && exercise.equipment) {
                    exercise.equipmentVariations = [exercise.equipment];
                }
                
                exerciseDB[name] = exercise;
            }
            
            console.log(`Loaded ${Object.keys(exerciseDB).length} exercises from external database`);
        } catch (error) {
            console.error('Error loading exercises database:', error);
            alert('Failed to load exercises database. Please check your internet connection and refresh the page.');
            // Set a fallback exercise so the app doesn't completely break
            exerciseDB = {
                'Barbell Bench Press': { muscleGroup: 'Chest', muscleGroups: ['Chest'], equipment: 'Olympic barbell, flat bench, safety rack', description: 'Horizontal chest press with barbell', difficulty: 'beginner', isBodyweight: false, equipmentVariations: ['Olympic barbell, flat bench, safety rack'] }
            };
        }
        
        equipmentDB = {};
        
        // Merge custom exercises into the main database
        if (appData.customExercises) {
            Object.assign(exerciseDB, appData.customExercises);
        }
        
        console.log('Exercise database loaded:', Object.keys(exerciseDB).length, 'exercises');
        console.log('Custom exercises:', Object.keys(appData.customExercises || {}).length);
    }
    
    // Initialize
    async function init() {
        loadData();
        await loadDatabases();
        updateWeekInfo();
        updateWorkoutDropdowns();
        loadActiveWorkout();
        showWorkoutsList();
        updateSummary();
        
        // Set up inactivity notifications
        setupInactivityListeners();
        await requestNotificationPermission();
        
        // Check if there's an active workout session
        if (currentWorkoutId || activeExercises.length > 0) {
            showActiveWorkoutInterface();
            resetInactivityTimer(); // Start the inactivity timer for active workouts
        }
    }
    
    function updateWeekInfo() {
        const now = new Date();
        const start = new Date(now.getFullYear(), 0, 1);
        const diff = now - start;
        const oneWeek = 604800000;
        const week = Math.ceil(diff / oneWeek);
        document.getElementById('weekInfo').textContent = 
            `Week ${week} ‚Ä¢ ${now.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' })}`;
    }
    
    // Tab navigation
    function showTab(tabName) {
        const tabs = ['workout', 'workouts', 'cardio', 'history', 'progress', 'settings'];
        tabs.forEach(tab => {
            document.getElementById(`${tab}Tab`).classList.toggle('hidden', tab !== tabName);
            const btn = document.querySelector(`.nav-btn[onclick="showTab('${tab}')"]`);
            if (btn) btn.classList.toggle('active', tab === tabName);
        });
        
        if (tabName === 'workouts') showWorkoutsList();
        if (tabName === 'cardio') showCardioHistory();
        if (tabName === 'history') showHistory();
        if (tabName === 'progress') showProgress();
        if (tabName === 'settings') showSettings();
    }
    window.showTab = showTab;
    
    // Timer functions
    function toggleTimer() {
        const content = document.getElementById('timerContent');
        const icon = document.getElementById('timerToggleIcon');
        content.classList.toggle('hidden');
        icon.textContent = content.classList.contains('hidden') ? '‚ñº' : '‚ñ≤';
    }
    window.toggleTimer = toggleTimer;
    
    function updateTimerDisplay() {
        const mins = Math.floor(timeRemaining / 60);
        const secs = timeRemaining % 60;
        const display = document.getElementById('timerDisplay');
        display.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
        
        display.classList.remove('warning', 'danger');
        if (timeRemaining <= 10) display.classList.add('danger');
        else if (timeRemaining <= 30) display.classList.add('warning');
    }
    
    function startTimer() {
        if (timeRemaining <= 0) {
            timeRemaining = 90;
        }
        
        if (timerRunning) {
            clearInterval(timerInterval);
            timerRunning = false;
            document.getElementById('startBtn').textContent = 'Start';
            document.getElementById('startBtn').classList.remove('stop');
            document.getElementById('startBtn').classList.add('start');
            return;
        }
        
        timerRunning = true;
        document.getElementById('startBtn').textContent = 'Stop';
        document.getElementById('startBtn').classList.remove('start');
        document.getElementById('startBtn').classList.add('stop');
        
        timerInterval = setInterval(() => {
            timeRemaining--;
            updateTimerDisplay();
            
            if (timeRemaining <= 0) {
                clearInterval(timerInterval);
                timerRunning = false;
                document.getElementById('startBtn').textContent = 'Start';
                document.getElementById('startBtn').classList.remove('stop');
                document.getElementById('startBtn').classList.add('start');
                
                if ('vibrate' in navigator) {
                    navigator.vibrate([200, 100, 200]);
                }
                
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZUR0MUKXh8LljHAU4kdfy0HYrBSl+zPLaizsIGGS57+mjVBcLTaXe8L5pIgQ1i9Xx0nwvBSF1xu/hlkQOFVy26+mrWBULTKLd8cBoIwU2jdXx0n0wBSaAze/emUIKFGC56+mrWRQLTKLd8cFoIgQ2jdXx03opBCp/zO/dmUIOFVy16+mtWhQLS6Hc8cRoJAQ2jdXx0n0wBSaAze/emUIKFGC56+mrWBULTKLd8cBqIgQ2jdXy0HopBCp/zO/dmUIOFVy16+mtWhQLS6Hc8cRoJAQ2jdXx0n0wBSaAze/emUIKFGC56+mrWBULTKLd8cBqIgQ2jdXy0HopBCp/zO/dmUIOFVy16+mtWhQLS6Hc8cRoJAQ2jdXx0n0wBSaAze/emUIKFGC56+mrWBULTKLd8cBqIgQ2jdXy0HopBCp/zO/dmUIOFVy16+mtWhQLS6Hc8cRoJAQ2jdXx0n0wBSaAze/emUIKFGC56+mrWBULTKLd8cBqIgQ2jdXy0HopBCp/zO/dmUIOFVy16+mtWhQLS6Hc8cRoJAQ2jdXx0n0wBSaAze/emUIKFGC56+mrWBULTKLd8cBqIgQ2jdXy0HopBCp/zO/dmUIOFVy16+mtWhQLS6Hc8cRoJAQ2jdXx0n0wBSaAze/emUIKFGC56+mrWBULTKLd8cBqIgQ2jdXy0HopBCp/zO/dmUIOFVy16+mtWhQLS6Hc8cRoJAQ2jdXx0n0wBSaAze/emUIKFGC56+mrWBULTKLd8cBqIgQ2jdXy0HopBCp/zO/dmUIOFVy16+mtWhQLS6Hc8cRoJAQ2jdXx0n0wBSaAze/emUIKFGC56+mrWBULTKLd8cBqIgQ2jdXy0HopBCp/zO/dmUIOFVy16+mtWhQLS6Hc8cRoJAQ2jdXx0n0wBSaAze/emUIKFGC56+mrWBULTKLd8cBqIgQ2jdXy0HopBCp/zO/dmUIOFVy16+mtWhQLS6Hc8cRoJAQ2jdXx0n0wBSaAze/emUIKFGC56+mrWBULTKLd8cBqIgQ2jdXy0HopBCp/zO/dmUIOFVy16+mtWhQLS6Hc8cRoJAQ=');
                audio.play().catch(() => {});
            }
        }, 1000);
    }
    window.startTimer = startTimer;
    
    function adjustTimer(seconds) {
        timeRemaining = Math.max(0, timeRemaining + seconds);
        updateTimerDisplay();
    }
    window.adjustTimer = adjustTimer;
    
    function setTimer(seconds) {
        timeRemaining = seconds;
        updateTimerDisplay();
        document.querySelectorAll('.time-preset').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
    }
    window.setTimer = setTimer;
    
    function resetTimer() {
        if (timerRunning) {
            clearInterval(timerInterval);
            timerRunning = false;
            document.getElementById('startBtn').textContent = 'Start';
            document.getElementById('startBtn').classList.remove('stop');
            document.getElementById('startBtn').classList.add('start');
        }
        timeRemaining = 90;
        updateTimerDisplay();
        document.querySelectorAll('.time-preset').forEach(btn => btn.classList.remove('active'));
    }
    window.resetTimer = resetTimer;
    
    // Inactivity notification functions
    async function requestNotificationPermission() {
        if (!('Notification' in window)) {
            console.log('This browser does not support notifications');
            return false;
        }
        
        if (Notification.permission === 'granted') {
            notificationPermissionGranted = true;
            return true;
        }
        
        if (Notification.permission !== 'denied') {
            const permission = await Notification.requestPermission();
            notificationPermissionGranted = permission === 'granted';
            return notificationPermissionGranted;
        }
        
        return false;
    }
    
    function showInactivityNotification() {
        console.log('showInactivityNotification called');
        console.log('Permission granted:', notificationPermissionGranted);
        console.log('Active exercises:', activeExercises.length);
        
        if (!notificationPermissionGranted || !('Notification' in window)) {
            console.log('Notification not supported or permission not granted');
            return;
        }
        
        // Only show if there's an active workout
        if (activeExercises.length === 0) {
            console.log('No active exercises, skipping notification');
            return;
        }
        
        console.log('Showing inactivity notification');
        
        try {
            const notification = new Notification('For Lifters Only', {
                body: 'Are you still there? Don\'t forget to submit your workout!',
                icon: 'icon-192.png',
                badge: 'icon-192.png',
                tag: 'inactivity-reminder',
                requireInteraction: false,
                silent: false,
                vibrate: [200, 100, 200]
            });
            
            notification.onclick = function() {
                window.focus();
                this.close();
            };
            
            console.log('Notification created successfully');
        } catch (error) {
            console.error('Error creating notification:', error);
        }
    }
    
    function resetInactivityTimer() {
        // Update last activity time
        lastActivityTime = Date.now();
        
        // Clear existing timer
        if (inactivityTimer) {
            clearTimeout(inactivityTimer);
            console.log('Cleared existing inactivity timer');
        }
        
        // Only set timer if there's an active workout
        if (activeExercises.length > 0) {
            const minutes = INACTIVITY_TIMEOUT / 1000 / 60;
            const targetTime = new Date(Date.now() + INACTIVITY_TIMEOUT);
            console.log('Setting inactivity timer for', minutes, 'minutes (will fire at', targetTime.toLocaleTimeString() + ')');
            console.log('Current active exercises:', activeExercises.length);
            
            inactivityTimer = setTimeout(() => {
                console.log('Inactivity timeout reached at', new Date().toLocaleTimeString());
                console.log('Active exercises at timeout:', activeExercises.length);
                showInactivityNotification();
            }, INACTIVITY_TIMEOUT);
        } else {
            console.log('Not setting inactivity timer - no active exercises');
        }
    }
    
    function clearInactivityTimer() {
        if (inactivityTimer) {
            clearTimeout(inactivityTimer);
            inactivityTimer = null;
        }
    }
    
    // Set up activity listeners to reset the inactivity timer
    function setupInactivityListeners() {
        const events = ['mousedown', 'keydown', 'scroll', 'touchstart', 'click'];
        
        events.forEach(event => {
            document.addEventListener(event, resetInactivityTimer, { passive: true });
        });
        
        // Add visibility change detection for when phone unlocks or tab comes back into focus
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                console.log('Page became visible again');
                checkInactivityOnWake();
            } else {
                console.log('Page hidden - saving last visibility time');
                lastVisibilityTime = Date.now();
            }
        });
        
        // Add page focus detection
        window.addEventListener('focus', () => {
            console.log('Window focused');
            checkInactivityOnWake();
        });
    }
    
    function checkInactivityOnWake() {
        // Check if there's an active workout
        if (activeExercises.length === 0) {
            console.log('No active workout, skipping inactivity check');
            return;
        }
        
        const now = Date.now();
        const timeSinceLastActivity = now - lastActivityTime;
        const minutesSinceActivity = Math.floor(timeSinceLastActivity / 1000 / 60);
        
        console.log('Checking inactivity on wake:');
        console.log('- Time since last activity:', minutesSinceActivity, 'minutes');
        console.log('- Inactivity threshold:', INACTIVITY_TIMEOUT / 1000 / 60, 'minutes');
        
        // If we've been inactive for more than the threshold, show notification
        if (timeSinceLastActivity >= INACTIVITY_TIMEOUT) {
            console.log('Inactive for', minutesSinceActivity, 'minutes - showing notification');
            showInactivityNotification();
        } else {
            console.log('Not inactive long enough yet');
            // Restart the timer for remaining time
            resetInactivityTimer();
        }
    }
    
    // Workout dropdown functions
    function updateWorkoutDropdowns() {
        const selects = [document.getElementById('workoutSelectStart')];
        const workouts = Object.entries(appData.workouts || {});
        
        selects.forEach(select => {
            if (!select) return;
            const currentValue = select.value;
            select.innerHTML = '<option value="">Select a workout...</option>' + 
                '<option value="custom">üèãÔ∏è Custom Workout</option>' +
                workouts.map(([id, w]) => 
                    `<option value="${id}">${w.name}</option>`
                ).join('');
            if (currentValue) select.value = currentValue;
        });
    }
    
    // Start a workout session
    function startWorkoutSession() {
        const select = document.getElementById('workoutSelectStart');
        const workoutId = select.value;
        
        if (!workoutId) {
            alert('Please select a workout!');
            return;
        }
        
        // Handle custom workout
        if (workoutId === 'custom') {
            // Check if bodyweight is set and remind user
            const currentBodyweight = parseFloat(appData.settings?.bodyWeight);
            if (!currentBodyweight) {
                const setBW = confirm('‚ö†Ô∏è No bodyweight set!\n\nFor accurate tracking of bodyweight exercises (pull-ups, push-ups, dips, etc.), set your bodyweight in Settings.\n\nContinue without setting bodyweight?');
                if (!setBW) {
                    showTab('settings');
                    return;
                }
            }
            
            currentWorkoutId = null; // No specific workout selected
            workoutStartTime = Date.now();
            document.getElementById('currentWorkoutName').textContent = 'Custom Workout';
            
            showActiveWorkoutInterface();
            saveActiveWorkout();
            return;
        }
        
        const workout = appData.workouts[workoutId];
        if (!workout) {
            alert('Workout not found!');
            return;
        }
        
        // Check if bodyweight is set and remind user
        const currentBodyweight = parseFloat(appData.settings?.bodyWeight);
        if (!currentBodyweight) {
            const setBW = confirm('‚ö†Ô∏è No bodyweight set!\n\nFor accurate tracking of bodyweight exercises (pull-ups, push-ups, dips, etc.), set your bodyweight in Settings.\n\nContinue without setting bodyweight?');
            if (!setBW) {
                showTab('settings');
                return;
            }
        }
        
        currentWorkoutId = workoutId;
        workoutStartTime = Date.now(); // Start duration tracking
        document.getElementById('currentWorkoutName').textContent = workout.name;
        
        // Show appropriate exercises based on muscle groups
        if (workout.muscleGroups && workout.muscleGroups.length > 0) {
            const matchingExercises = Object.entries(exerciseDB)
                .filter(([_, ex]) => {
                    const exMuscles = ex.muscleGroups || (ex.muscleGroup ? [ex.muscleGroup] : []);
                    return exMuscles.some(m => workout.muscleGroups.includes(m));
                })
                .slice(0, 10);
            
            if (matchingExercises.length > 0) {
                displaySearchResults(matchingExercises);
                document.getElementById('searchResults').classList.remove('hidden');
            }
        }
        
        showActiveWorkoutInterface();
        saveActiveWorkout();
        resetInactivityTimer(); // Start the 30-minute inactivity timer
    }
    window.startWorkoutSession = startWorkoutSession;
    
    function showActiveWorkoutInterface() {
        document.getElementById('workoutSelection').classList.add('hidden');
        document.getElementById('activeWorkoutInterface').classList.remove('hidden');
        renderExerciseList();
        updateSummary();
    }
    
    function endWorkoutSession() {
        if (!confirm('‚ö†Ô∏è End workout and discard all data?\n\nAll exercises and sets will be deleted. This cannot be undone.')) return;
        
        clearInactivityTimer(); // Clear the inactivity timer when workout is cancelled
        
        // Clear all exercises
        activeExercises = [];
        currentWorkoutId = null;
        workoutStartTime = null; // Reset duration tracking
        
        // Update UI
        document.getElementById('workoutSelection').classList.remove('hidden');
        document.getElementById('activeWorkoutInterface').classList.add('hidden');
        document.getElementById('workoutSelectStart').value = '';
        document.getElementById('exerciseSearch').value = '';
        document.getElementById('searchResults').classList.add('hidden');
        document.getElementById('exerciseList').innerHTML = '';
        
        // Clear saved active workout from storage
        appData.activeWorkout = {};
        saveData();
        
        updateSummary();
    }
    window.endWorkoutSession = endWorkoutSession;
    
    // Exercise search
    function searchExercises() {
        const query = document.getElementById('exerciseSearch').value.trim().toLowerCase();
        const results = document.getElementById('searchResults');
        
        if (!query) {
            results.classList.add('hidden');
            return;
        }
        
        const matches = Object.entries(exerciseDB).filter(([name, _]) => 
            name.toLowerCase().includes(query)
        );
        
        displaySearchResults(matches);
        results.classList.remove('hidden');
    }
    window.searchExercises = searchExercises;
    
    function displaySearchResults(exercises) {
        const results = document.getElementById('searchResults');
        
        if (exercises.length === 0) {
            results.innerHTML = '<div style="padding: 15px; text-align: center; opacity: 0.7;">No exercises found</div>';
            return;
        }
        
        results.innerHTML = exercises.slice(0, 20).map(([name, ex]) => {
            const muscles = ex.muscleGroups || (ex.muscleGroup ? [ex.muscleGroup] : []);
            const muscleText = muscles.length > 0 ? muscles.join(', ') : 'No muscle groups';
            
            const difficultyColor = {
                'beginner': '#10b981',
                'intermediate': '#f59e0b',
                'advanced': '#ef4444'
            }[ex.difficulty] || '#6b7280';
            
            return `
                <div class="search-result" data-exercise-name="${name.replace(/"/g, '&quot;')}">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 3px;">
                        <div style="font-weight: 600; flex: 1;">
                            ${name}
                            ${ex.isCustom ? '<span style="font-size: 10px; padding: 2px 6px; border-radius: 10px; background: rgba(59, 130, 246, 0.2); color: #60a5fa; margin-left: 4px;">CUSTOM</span>' : ''}
                        </div>
                        <div style="font-size: 10px; padding: 2px 6px; border-radius: 10px; background: rgba(255,255,255,0.1); color: ${difficultyColor};">
                            ${ex.difficulty || 'beginner'}
                        </div>
                    </div>
                    <div style="font-size: 11px; opacity: 0.7; margin-bottom: 2px;">
                        ${muscleText}
                    </div>
                    <div style="font-size: 11px; opacity: 0.6;">
                        üîß ${ex.equipment || 'No equipment specified'}
                    </div>
                    ${ex.description ? `<div style="font-size: 10px; opacity: 0.5; margin-top: 3px; font-style: italic;">${ex.description.substring(0, 80)}${ex.description.length > 80 ? '...' : ''}</div>` : ''}
                </div>
            `;
        }).join('');
        
        // Add event delegation for search results
        results.querySelectorAll('.search-result').forEach(result => {
            result.addEventListener('click', function() {
                const exerciseName = this.getAttribute('data-exercise-name');
                selectExercise(exerciseName);
            });
        });
    }
    
    function selectExercise(name) {
        const exercise = exerciseDB[name];
        if (!exercise) {
            console.error('Exercise not found:', name);
            return;
        }
        
        console.log('Selecting exercise:', name, exercise);
        addExerciseToWorkout(name, exercise.equipment || 'None');
    }
    window.selectExercise = selectExercise;
    
    function addExerciseToWorkout(name, equipment) {
        console.log('addExerciseToWorkout called:', name, equipment);
        
        const existingIndex = activeExercises.findIndex(ex => 
            ex.name === name && ex.equipment === equipment
        );
        
        if (existingIndex !== -1) {
            alert('Exercise already added!');
            return;
        }
        
        // Find the last time this exercise was performed
        const history = Object.values(appData.history || {}).sort((a, b) => 
            new Date(b.date) - new Date(a.date)
        );
        
        let previousSets = [];
        for (const workout of history) {
            const previousExercise = workout.exercises?.find(ex => ex.name === name);
            if (previousExercise && previousExercise.sets && previousExercise.sets.length > 0) {
                // Found it! Use the sets from last time
                previousSets = previousExercise.sets.map(set => ({
                    weight: set.weight || '',
                    reps: set.reps || ''
                }));
                break;
            }
        }
        
        // If no previous data found, start with one empty set
        if (previousSets.length === 0) {
            previousSets = [{ weight: '', reps: '' }];
        }
        
        const newExercise = {
            id: Date.now(),
            name: name,
            equipment: equipment,
            sets: previousSets,
            collapsed: false
        };
        
        activeExercises.push(newExercise);
        console.log('Exercise added. Active exercises:', activeExercises);
        
        resetInactivityTimer(); // Reset timer when exercise is added
        
        document.getElementById('exerciseSearch').value = '';
        document.getElementById('searchResults').classList.add('hidden');
        document.getElementById('workoutSelectStart').value = '';
        
        renderExerciseList();
        updateSummary();
        saveActiveWorkout();
    }
    window.addExerciseToWorkout = addExerciseToWorkout;
    
    function renderExerciseList() {
        const container = document.getElementById('exerciseList');
        
        if (activeExercises.length === 0) {
            container.innerHTML = '';
            return;
        }
        
        const currentBodyweight = parseFloat(appData.settings?.bodyWeight) || null;
        
        container.innerHTML = activeExercises.map(ex => {
            const history = getExerciseHistory(ex.name, ex.equipment);
            const hasHistory = history.length > 0;
            const exerciseData = exerciseDB[ex.name];
            const isBodyweight = exerciseData?.isBodyweight || false;
            
            return `
                <div class="exercise-item">
                    <div class="exercise-header" data-action="toggle-collapse" data-exercise-id="${ex.id}">
                        <div>
                            <div class="exercise-name">${ex.name}</div>
                            <div style="font-size: 11px; opacity: 0.7;">
                                ${ex.equipment}
                                ${isBodyweight ? ' ‚Ä¢ <span style="color: #10b981;">Bodyweight</span>' : ''}
                                ${isBodyweight && currentBodyweight ? ` ‚Ä¢ ${currentBodyweight} lbs` : ''}
                                ${isBodyweight && !currentBodyweight ? ' ‚Ä¢ <span style="color: #f59e0b;">Set bodyweight in settings</span>' : ''}
                            </div>
                        </div>
                        <div class="exercise-actions">
                            <button class="icon-btn" data-action="remove-exercise" data-exercise-id="${ex.id}">√ó</button>
                            <span style="opacity: 0.5; font-size: 14px;">${ex.collapsed ? '‚ñº' : '‚ñ≤'}</span>
                        </div>
                    </div>
                    
                    <div class="exercise-content" style="display: ${ex.collapsed ? 'none' : 'block'};">
                        <div id="sets-${ex.id}">
                            ${ex.sets.map((set, idx) => {
                                const addedWeight = parseFloat(set.weight) || 0;
                                const totalWeight = isBodyweight && currentBodyweight ? addedWeight + currentBodyweight : addedWeight;
                                
                                return `
                                <div class="set-row">
                                    <div class="set-number">${idx + 1}</div>
                                    <input type="number" 
                                           class="exercise-input" 
                                           placeholder="${isBodyweight ? '+lbs' : 'lbs'}" 
                                           value="${set.weight || ''}"
                                           data-action="update-set"
                                           data-exercise-id="${ex.id}"
                                           data-set-index="${idx}"
                                           data-field="weight"
                                           min="0"
                                           step="2.5"
                                           title="${isBodyweight && currentBodyweight ? `Total: ${totalWeight} lbs (${currentBodyweight} + ${addedWeight})` : ''}">
                                    <input type="number" 
                                           class="exercise-input" 
                                           placeholder="reps" 
                                           value="${set.reps || ''}"
                                           data-action="update-set"
                                           data-exercise-id="${ex.id}"
                                           data-set-index="${idx}"
                                           data-field="reps"
                                           min="0"
                                           step="1">
                                    <button class="set-btn" data-action="remove-set" data-exercise-id="${ex.id}" data-set-index="${idx}">√ó</button>
                                </div>
                            `}).join('')}
                        </div>
                        ${isBodyweight && currentBodyweight ? `
                            <div style="font-size: 11px; opacity: 0.7; margin-top: 6px; padding: 6px; background: rgba(16, 185, 129, 0.1); border-radius: 6px;">
                                üí° Weight field is for added weight (e.g., weighted vest, dip belt). Total = ${currentBodyweight} lbs + added weight.
                            </div>
                        ` : ''}
                        <button class="action-btn success" data-action="add-set" data-exercise-id="${ex.id}" style="width: 100%; margin-top: 8px;">
                            + Add Set
                        </button>
                        ${hasHistory ? `
                            <div class="history-section" id="history-${ex.id}">
                                <div class="history-toggle" data-action="toggle-history" data-exercise-id="${ex.id}">
                                    <span>üìä Previous Sessions</span>
                                    <span id="history-icon-${ex.id}">‚ñº</span>
                                </div>
                                <div id="history-content-${ex.id}" style="display: none;">
                                    ${history.slice(0, 3).map(h => {
                                        const workoutBW = h.bodyweight || null;
                                        return `
                                        <div class="history-entry">
                                            <div style="font-weight: 600; margin-bottom: 2px;">
                                                ${new Date(h.date).toLocaleDateString()}
                                                ${workoutBW ? ` ‚Ä¢ BW: ${workoutBW} lbs` : ''}
                                            </div>
                                            ${h.sets.map((s, i) => {
                                                const setWeight = parseFloat(s.weight) || 0;
                                                const actualWeight = s.actualWeight || setWeight;
                                                const displayText = isBodyweight && workoutBW ? 
                                                    `Set ${i+1}: ${actualWeight}lbs (${workoutBW}+${setWeight}) √ó ${s.reps} reps` :
                                                    `Set ${i+1}: ${setWeight}lbs √ó ${s.reps} reps`;
                                                return `<div style="font-size: 11px;">${displayText}</div>`;
                                            }).join('')}
                                        </div>
                                    `}).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }).join('');
        
        // Add event delegation for all exercise interactions
        container.querySelectorAll('[data-action]').forEach(element => {
            const action = element.getAttribute('data-action');
            
            if (action === 'toggle-collapse') {
                element.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-exercise-id'));
                    toggleExerciseCollapse(id);
                });
            } else if (action === 'remove-exercise') {
                element.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const id = parseInt(this.getAttribute('data-exercise-id'));
                    removeExercise(id);
                });
            } else if (action === 'update-set') {
                // Use 'blur' instead of 'change' for validation to work better
                element.addEventListener('blur', function() {
                    const exerciseId = parseInt(this.getAttribute('data-exercise-id'));
                    const setIndex = parseInt(this.getAttribute('data-set-index'));
                    const field = this.getAttribute('data-field');
                    updateSet(exerciseId, setIndex, field, this.value);
                });
                // Also save on 'change' but without validation prompt (for immediate updates)
                element.addEventListener('input', function() {
                    const exerciseId = parseInt(this.getAttribute('data-exercise-id'));
                    const setIndex = parseInt(this.getAttribute('data-set-index'));
                    const field = this.getAttribute('data-field');
                    const exercise = activeExercises.find(ex => ex.id === exerciseId);
                    if (exercise && exercise.sets[setIndex]) {
                        exercise.sets[setIndex][field] = this.value;
                        updateSummary();
                    }
                });
            } else if (action === 'remove-set') {
                element.addEventListener('click', function() {
                    const exerciseId = parseInt(this.getAttribute('data-exercise-id'));
                    const setIndex = parseInt(this.getAttribute('data-set-index'));
                    removeSet(exerciseId, setIndex);
                });
            } else if (action === 'add-set') {
                element.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-exercise-id'));
                    addSet(id);
                });
            } else if (action === 'toggle-history') {
                element.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-exercise-id'));
                    toggleHistory(id);
                });
            }
        });
    }
    
    function toggleExerciseCollapse(id) {
        const exercise = activeExercises.find(ex => ex.id === id);
        if (exercise) {
            exercise.collapsed = !exercise.collapsed;
            renderExerciseList();
            saveActiveWorkout();
        }
    }
    window.toggleExerciseCollapse = toggleExerciseCollapse;
    
    function toggleHistory(id) {
        const content = document.getElementById(`history-content-${id}`);
        const icon = document.getElementById(`history-icon-${id}`);
        if (content && icon) {
            const isHidden = content.style.display === 'none';
            content.style.display = isHidden ? 'block' : 'none';
            icon.textContent = isHidden ? '‚ñ≤' : '‚ñº';
        }
    }
    window.toggleHistory = toggleHistory;
    
    function getExerciseHistory(name, equipment) {
        const history = [];
        Object.entries(appData.history || {}).forEach(([date, workout]) => {
            const exercise = workout.exercises?.find(ex => 
                ex.name === name && ex.equipment === equipment
            );
            if (exercise && exercise.sets && exercise.sets.length > 0) {
                history.push({
                    date: date,
                    sets: exercise.sets,
                    bodyweight: workout.bodyweight || null
                });
            }
        });
        return history.sort((a, b) => new Date(b.date) - new Date(a.date));
    }
    
    function getExerciseMaxValues(exerciseName) {
        // Get historical max values for this exercise
        const history = Object.values(appData.history || {});
        let maxWeight = 0;
        let maxReps = 0;
        
        for (const workout of history) {
            const exercise = workout.exercises?.find(ex => ex.name === exerciseName);
            if (exercise && exercise.sets) {
                for (const set of exercise.sets) {
                    const weight = parseFloat(set.weight) || 0;
                    const reps = parseFloat(set.reps) || 0;
                    if (weight > maxWeight) maxWeight = weight;
                    if (reps > maxReps) maxReps = reps;
                }
            }
        }
        
        return { maxWeight, maxReps };
    }
    
    function validateSetValue(exerciseName, field, value) {
        // Convert to number
        const numValue = parseFloat(value);
        if (isNaN(numValue) || numValue <= 0) {
            return { valid: true, correctedValue: value }; // Let empty/invalid through
        }
        
        // Get historical maxes
        const { maxWeight, maxReps } = getExerciseMaxValues(exerciseName);
        
        // Define thresholds based on field type
        if (field === 'weight') {
            // Absolute maximum limits
            const ABSOLUTE_MAX_WEIGHT = 1000; // Nobody is lifting 1000lbs
            
            if (numValue > ABSOLUTE_MAX_WEIGHT) {
                // Definitely a typo - try removing last digit
                const corrected = Math.floor(numValue / 10);
                return {
                    valid: false,
                    correctedValue: corrected,
                    message: `${numValue} lbs seems unrealistic. Did you mean ${corrected} lbs?`
                };
            }
            
            // Check against historical max (if we have history)
            if (maxWeight > 0) {
                // If new value is more than 2.5x previous max, likely a typo
                const threshold = maxWeight * 2.5;
                if (numValue > threshold) {
                    // Try removing last digit
                    const corrected = Math.floor(numValue / 10);
                    
                    // Only suggest correction if it's within reasonable range
                    if (corrected <= threshold || corrected <= maxWeight * 1.5) {
                        return {
                            valid: false,
                            correctedValue: corrected,
                            message: `${numValue} lbs is much higher than your previous max (${maxWeight} lbs). Did you mean ${corrected} lbs?`
                        };
                    } else {
                        // Even the correction is too high, just warn
                        return {
                            valid: false,
                            correctedValue: numValue,
                            message: `${numValue} lbs is much higher than your previous max (${maxWeight} lbs). Is this correct?`
                        };
                    }
                }
            }
        } else if (field === 'reps') {
            // Absolute maximum limits
            const ABSOLUTE_MAX_REPS = 100; // Very high but possible for bodyweight exercises
            
            if (numValue > ABSOLUTE_MAX_REPS) {
                // Definitely a typo - try removing last digit
                const corrected = Math.floor(numValue / 10);
                return {
                    valid: false,
                    correctedValue: corrected,
                    message: `${numValue} reps seems unrealistic. Did you mean ${corrected} reps?`
                };
            }
            
            // Check against historical max (if we have history)
            if (maxReps > 0) {
                // If new value is more than 3x previous max, likely a typo
                const threshold = maxReps * 3;
                if (numValue > threshold) {
                    // Try removing last digit
                    const corrected = Math.floor(numValue / 10);
                    
                    // Only suggest correction if it's within reasonable range
                    if (corrected <= threshold || corrected <= maxReps * 2) {
                        return {
                            valid: false,
                            correctedValue: corrected,
                            message: `${numValue} reps is much higher than your previous max (${maxReps} reps). Did you mean ${corrected} reps?`
                        };
                    } else {
                        // Even the correction is too high, just warn
                        return {
                            valid: false,
                            correctedValue: numValue,
                            message: `${numValue} reps is much higher than your previous max (${maxReps} reps). Is this correct?`
                        };
                    }
                }
            }
        }
        
        return { valid: true, correctedValue: value };
    }
    
    function updateSet(exerciseId, setIndex, field, value) {
        const exercise = activeExercises.find(ex => ex.id === exerciseId);
        if (!exercise || !exercise.sets[setIndex]) return;
        
        // Only validate weight and reps fields
        if (field === 'weight' || field === 'reps') {
            const validation = validateSetValue(exercise.name, field, value);
            
            if (!validation.valid) {
                // Show confirmation dialog with suggestion
                const userResponse = confirm(validation.message + '\n\nClick OK to use the suggested value, or Cancel to keep what you entered.');
                
                if (userResponse) {
                    // Use the corrected value
                    exercise.sets[setIndex][field] = validation.correctedValue.toString();
                } else {
                    // Keep the original value
                    exercise.sets[setIndex][field] = value;
                }
                
                // Re-render to show the updated value
                renderExerciseList();
                updateSummary();
                saveActiveWorkout();
                return;
            }
        }
        
        // If validation passed or not a weight/reps field, save normally
        exercise.sets[setIndex][field] = value;
        updateSummary();
        saveActiveWorkout();
    }
    window.updateSet = updateSet;
    
    function addSet(exerciseId) {
        const exercise = activeExercises.find(ex => ex.id === exerciseId);
        if (exercise) {
            const lastSet = exercise.sets[exercise.sets.length - 1];
            exercise.sets.push({
                weight: lastSet?.weight || '',
                reps: lastSet?.reps || ''
            });
            renderExerciseList();
            saveActiveWorkout();
        }
    }
    window.addSet = addSet;
    
    function removeSet(exerciseId, setIndex) {
        const exercise = activeExercises.find(ex => ex.id === exerciseId);
        if (exercise && exercise.sets.length > 1) {
            exercise.sets.splice(setIndex, 1);
            renderExerciseList();
            updateSummary();
            saveActiveWorkout();
        }
    }
    window.removeSet = removeSet;
    
    function removeExercise(id) {
        if (confirm('Remove this exercise?')) {
            activeExercises = activeExercises.filter(ex => ex.id !== id);
            renderExerciseList();
            updateSummary();
            saveActiveWorkout();
        }
    }
    window.removeExercise = removeExercise;
    
    function updateSummary() {
        const exerciseCount = activeExercises.length;
        const setCount = activeExercises.reduce((sum, ex) => sum + ex.sets.length, 0);
        const currentBodyweight = parseFloat(appData.settings?.bodyWeight) || 0;
        
        const volume = activeExercises.reduce((sum, ex) => {
            const exerciseData = exerciseDB[ex.name];
            const isBodyweight = exerciseData?.isBodyweight || false;
            
            return sum + ex.sets.reduce((exSum, set) => {
                const addedWeight = parseFloat(set.weight) || 0;
                const reps = parseFloat(set.reps) || 0;
                
                // For bodyweight exercises, include bodyweight in calculation
                const totalWeight = isBodyweight && currentBodyweight ? 
                    addedWeight + currentBodyweight : 
                    addedWeight;
                
                return exSum + (totalWeight * reps);
            }, 0);
        }, 0);
        
        document.getElementById('exerciseCount').textContent = exerciseCount;
        document.getElementById('setCount').textContent = setCount;
        document.getElementById('volumeCount').textContent = Math.round(volume);
    }
    
    function finishWorkout() {
        if (activeExercises.length === 0) {
            alert('Add at least one exercise!');
            return;
        }
        
        const hasData = activeExercises.some(ex => 
            ex.sets.some(s => s.weight || s.reps)
        );
        
        if (!hasData) {
            alert('Enter at least one set!');
            return;
        }
        
        // Check if cardio was done today
        const today = new Date().toISOString().split('T')[0]; // Get today's date in YYYY-MM-DD format
        const cardioToday = Object.keys(appData.cardio || {}).some(dateKey => {
            const cardioDate = new Date(dateKey).toISOString().split('T')[0];
            return cardioDate === today;
        });
        
        // Cardio confirmation - only ask if no cardio was done today
        if (!cardioToday) {
            if (!confirm('No cardio? Are you sure you want to leave?')) {
                return;
            }
        }
        
        // Get current bodyweight
        const currentBodyweight = parseFloat(appData.settings?.bodyWeight) || null;
        
        // Calculate workout duration
        const durationMinutes = workoutStartTime ? Math.round((Date.now() - workoutStartTime) / 60000) : 0;
        
        const workout = {
            date: new Date().toISOString(),
            workoutId: currentWorkoutId,
            workoutName: currentWorkoutId ? appData.workouts[currentWorkoutId]?.name : 'Custom',
            bodyweight: currentBodyweight, // Save bodyweight with workout
            duration: durationMinutes, // Save duration in minutes
            exercises: activeExercises.map(ex => {
                const exerciseData = exerciseDB[ex.name];
                const muscles = exerciseData?.muscleGroups || (exerciseData?.muscleGroup ? [exerciseData.muscleGroup] : []);
                const isBodyweight = exerciseData?.isBodyweight || false;
                
                return {
                    name: ex.name,
                    equipment: ex.equipment,
                    isBodyweight: isBodyweight,
                    sets: ex.sets.filter(s => s.weight || s.reps).map(s => ({
                        weight: s.weight,
                        reps: s.reps,
                        // For bodyweight exercises, calculate total weight moved
                        actualWeight: isBodyweight && currentBodyweight ? 
                            (parseFloat(s.weight) || 0) + currentBodyweight : 
                            parseFloat(s.weight) || 0
                    })),
                    muscleGroups: muscles
                };
            }).filter(ex => ex.sets.length > 0)
        };
        
        appData.history[workout.date] = workout;
        appData.activeWorkout = {};
        saveData();
        
        clearInactivityTimer(); // Clear the inactivity timer when workout is submitted
        
        activeExercises = [];
        currentWorkoutId = null;
        workoutStartTime = null; // Reset duration tracking
        document.getElementById('exerciseList').innerHTML = '';
        document.getElementById('workoutSelection').classList.remove('hidden');
        document.getElementById('activeWorkoutInterface').classList.add('hidden');
        document.getElementById('workoutSelectStart').value = '';
        updateSummary();
    }
    window.finishWorkout = finishWorkout;
    
    // Workout management
    function showWorkoutForm() {
        editingWorkoutId = null;
        document.getElementById('workoutForm').classList.remove('hidden');
        document.getElementById('createWorkoutBtn').style.display = 'none';
        document.getElementById('workoutsList').innerHTML = '';
        document.getElementById('workoutName').value = '';
        document.querySelectorAll('.muscle-checkbox').forEach(cb => cb.checked = false);
    }
    window.showWorkoutForm = showWorkoutForm;
    
    function hideWorkoutForm() {
        document.getElementById('workoutForm').classList.add('hidden');
        document.getElementById('createWorkoutBtn').style.display = '';
        showWorkoutsList();
    }
    window.hideWorkoutForm = hideWorkoutForm;
    
    function saveWorkout() {
        const name = document.getElementById('workoutName').value.trim();
        if (!name) {
            alert('Enter workout name');
            return;
        }
        
        const selectedMuscles = Array.from(document.querySelectorAll('.muscle-checkbox:checked'))
            .map(cb => cb.value);
        
        if (selectedMuscles.length === 0) {
            alert('Select at least one muscle group');
            return;
        }
        
        const id = editingWorkoutId || Date.now().toString();
        appData.workouts[id] = { 
            name: name,
            muscleGroups: selectedMuscles
        };
        saveData();
        
        hideWorkoutForm();
        updateWorkoutDropdowns();
    }
    window.saveWorkout = saveWorkout;
    
    function editWorkout(workoutId) {
        const workout = appData.workouts[workoutId];
        if (!workout) return;
        
        editingWorkoutId = workoutId;
        
        // Show the form
        showWorkoutForm();
        
        // Populate the form with existing data
        document.getElementById('workoutName').value = workout.name;
        
        // Check the muscle group checkboxes
        document.querySelectorAll('.muscle-checkbox').forEach(cb => {
            cb.checked = workout.muscleGroups.includes(cb.value);
        });
    }
    window.editWorkout = editWorkout;
    
    function showWorkoutsList() {
        const container = document.getElementById('workoutsList');
        const workouts = Object.entries(appData.workouts || {});
        
        if (!document.getElementById('workoutForm').classList.contains('hidden')) {
            container.innerHTML = '';
            return;
        }
        
        if (!workouts.length) {
            container.innerHTML = '<p style="text-align: center; opacity: 0.7; margin-top: 15px;">No workouts yet.</p>';
            return;
        }
        
        let html = '<h3 style="color: #10b981; margin: 15px 0 10px;">Your Workouts</h3>';
        workouts.forEach(([id, w]) => {
            const muscleGroupsText = w.muscleGroups ? w.muscleGroups.join(', ') : 'No muscle groups';
            html += `
                <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 10px;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #10b981; margin-bottom: 4px;">${w.name}</div>
                            <div style="font-size: 12px; opacity: 0.8;">${muscleGroupsText}</div>
                        </div>
                        <div style="display: flex; gap: 6px;">
                            <button class="action-btn primary edit-workout-btn" data-workout-id="${id}">Edit</button>
                            <button class="action-btn danger delete-workout-btn" data-workout-id="${id}">Delete</button>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
        // Edit button listeners
        container.querySelectorAll('.edit-workout-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.dataset.workoutId;
                editWorkout(id);
            });
        });
        
        // Delete button listeners
        container.querySelectorAll('.delete-workout-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.dataset.workoutId;
                if (confirm('Delete this workout?')) {
                    delete appData.workouts[id];
                    saveData();
                    updateWorkoutDropdowns();
                    showWorkoutsList();
                }
            });
        });
    }
    
    function calculateStreakStats() {
        const historyDates = Object.keys(appData.history || {}).map(dateStr => {
            const d = new Date(dateStr);
            return new Date(d.getFullYear(), d.getMonth(), d.getDate()).getTime();
        }).filter(date => !isNaN(date));
        
        if (historyDates.length === 0) {
            return { currentStreak: 0, bestStreakMonth: 0, daysThisWeek: 0, daysThisMonth: 0 };
        }
        
        const uniqueDates = [...new Set(historyDates)].sort((a, b) => b - a);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayTime = today.getTime();
        
        // Calculate current streak
        let currentStreak = 0;
        let checkDate = todayTime;
        
        for (let i = 0; i < uniqueDates.length; i++) {
            if (uniqueDates[i] === checkDate) {
                currentStreak++;
                checkDate -= 86400000; // Go back one day
            } else if (uniqueDates[i] < checkDate) {
                break;
            }
        }
        
        // Calculate best streak this month
        const thisMonth = today.getMonth();
        const thisYear = today.getFullYear();
        const thisMonthDates = uniqueDates.filter(d => {
            const date = new Date(d);
            return date.getMonth() === thisMonth && date.getFullYear() === thisYear;
        }).sort((a, b) => a - b);
        
        let bestStreakMonth = 0;
        let tempStreak = 0;
        let lastDate = null;
        
        for (const dateTime of thisMonthDates) {
            if (lastDate === null || dateTime === lastDate + 86400000) {
                tempStreak++;
                bestStreakMonth = Math.max(bestStreakMonth, tempStreak);
            } else {
                tempStreak = 1;
            }
            lastDate = dateTime;
        }
        
        // Calculate days this week
        const startOfWeek = new Date(today);
        startOfWeek.setDate(today.getDate() - today.getDay()); // Sunday
        const daysThisWeek = uniqueDates.filter(d => d >= startOfWeek.getTime() && d <= todayTime).length;
        
        // Calculate days this month
        const startOfMonth = new Date(thisYear, thisMonth, 1);
        const daysThisMonth = uniqueDates.filter(d => {
            const date = new Date(d);
            return date.getMonth() === thisMonth && date.getFullYear() === thisYear;
        }).length;
        
        return { currentStreak, bestStreakMonth, daysThisWeek, daysThisMonth };
    }
    
    function showHistory() {
        // Calculate and display stats
        const stats = calculateStreakStats();
        document.getElementById('currentStreak').textContent = stats.currentStreak;
        document.getElementById('bestStreakMonthSub').textContent = `(Best: ${stats.bestStreakMonth})`;
        document.getElementById('daysThisWeek').textContent = stats.daysThisWeek;
        document.getElementById('daysThisMonth').textContent = stats.daysThisMonth;
        
        const container = document.getElementById('historyContent');
        const history = Object.entries(appData.history || {})
            .sort((a, b) => new Date(b[0]) - new Date(a[0]))
            .slice(0, 20);
        
        if (!history.length) {
            container.innerHTML = '<p>No workouts yet</p>';
            return;
        }
        
        container.innerHTML = history.map(([key, w]) => {
            const date = new Date(key);
            const exerciseCount = w.exercises ? w.exercises.length : 0;
            const setCount = w.exercises ? w.exercises.reduce((sum, ex) => sum + (ex.sets?.length || 0), 0) : 0;
            const bodyweight = w.bodyweight ? `${w.bodyweight} lbs` : 'Not recorded';
            
            // Calculate total volume
            const volume = w.exercises ? w.exercises.reduce((sum, ex) => {
                return sum + (ex.sets || []).reduce((exSum, set) => {
                    const weight = set.actualWeight || parseFloat(set.weight) || 0;
                    const reps = parseFloat(set.reps) || 0;
                    return exSum + (weight * reps);
                }, 0);
            }, 0) : 0;
            
            // Get workout day name - make it prominent
            const workoutDayName = w.workoutName || 'Custom Workout';
            
            return `
                <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; margin-bottom: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                        <div>
                            <div style="font-weight: 700; color: #10b981; font-size: 16px; margin-bottom: 2px;">
                                ${workoutDayName}
                            </div>
                            <div style="font-size: 12px; opacity: 0.8;">
                                ${date.toLocaleDateString()} at ${date.toLocaleTimeString()}
                                ${w.duration ? ` ‚Ä¢ ‚è±Ô∏è ${w.duration} min` : ''}
                            </div>
                        </div>
                        <div style="text-align: right; font-size: 11px; opacity: 0.7;">
                            ${exerciseCount} exercises<br>${setCount} sets
                        </div>
                    </div>
                    <div style="font-size: 12px; margin-top: 4px; opacity: 0.7;">
                        üí™ Bodyweight: ${bodyweight} ‚Ä¢ Volume: ${Math.round(volume)} lbs
                    </div>
                    <div style="font-size: 11px; margin-top: 4px; opacity: 0.6; line-height: 1.4;">
                        ${w.exercises?.map(ex => ex.name).join(', ') || 'No exercises'}
                    </div>
                </div>
            `;
        }).join('');
    }
    
    // Cardio Functions
    function saveCardioSession() {
        const type = document.getElementById('cardioType').value;
        const duration = parseFloat(document.getElementById('cardioDuration').value);
        const distance = parseFloat(document.getElementById('cardioDistance').value) || null;
        const calories = parseFloat(document.getElementById('cardioCalories').value) || null;
        
        if (!type) {
            alert('Please select a cardio type!');
            return;
        }
        
        if (!duration || duration <= 0) {
            alert('Please enter duration!');
            return;
        }
        
        const session = {
            type: type,
            duration: duration,
            distance: distance,
            calories: calories,
            date: new Date().toISOString()
        };
        
        appData.cardio[session.date] = session;
        saveData();
        
        // Clear form
        document.getElementById('cardioType').value = '';
        document.getElementById('cardioDuration').value = '';
        document.getElementById('cardioDistance').value = '';
        document.getElementById('cardioCalories').value = '';
        
        showCardioHistory();
        alert('Cardio session saved!');
    }
    window.saveCardioSession = saveCardioSession;
    
    function showCardioHistory() {
        const container = document.getElementById('cardioHistoryContent');
        const sessions = Object.entries(appData.cardio || {})
            .sort((a, b) => new Date(b[0]) - new Date(a[0]))
            .slice(0, 20);
        
        if (!sessions.length) {
            container.innerHTML = '<p style="text-align: center; opacity: 0.7;">No cardio sessions yet</p>';
            return;
        }
        
        container.innerHTML = sessions.map(([key, s]) => {
            const date = new Date(key);
            const distanceText = s.distance ? ` ‚Ä¢ ${s.distance} mi` : '';
            const caloriesText = s.calories ? ` ‚Ä¢ ${s.calories} cal` : '';
            const pace = s.distance && s.duration ? ` (${(s.duration / s.distance).toFixed(1)} min/mi)` : '';
            
            return `
                <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #10b981; font-size: 14px;">
                            ${s.type}
                        </div>
                        <div style="font-size: 12px; opacity: 0.8; margin-top: 2px;">
                            ${date.toLocaleDateString()} at ${date.toLocaleTimeString()}
                        </div>
                        <div style="font-size: 12px; margin-top: 2px; opacity: 0.7;">
                            ‚è±Ô∏è ${s.duration} min${distanceText}${caloriesText}${pace}
                        </div>
                    </div>
                    <button class="action-btn danger" onclick="deleteCardioSession('${key}')" style="padding: 6px 12px; font-size: 12px;">Delete</button>
                </div>
            `;
        }).join('');
    }
    
    function deleteCardioSession(sessionKey) {
        if (confirm('Delete this cardio session?')) {
            delete appData.cardio[sessionKey];
            saveData();
            showCardioHistory();
        }
    }
    window.deleteCardioSession = deleteCardioSession;
    
    function showProgress() {
        const content = document.getElementById('progressContent');
        const history = Object.values(appData.history || {}).sort((a, b) => 
            new Date(b.date) - new Date(a.date)
        );
        
        let html = '';
        
        // Cardio Progress Section
        const cardioSessions = Object.entries(appData.cardio || {}).sort((a, b) => new Date(b[0]) - new Date(a[0]));
        
        if (cardioSessions.length > 0) {
            // Group by type
            const cardioByType = {};
            cardioSessions.forEach(([date, session]) => {
                if (!cardioByType[session.type]) {
                    cardioByType[session.type] = [];
                }
                cardioByType[session.type].push({ ...session, date });
            });
            
            html += '<h4 style="color: #3b82f6; margin-bottom: 10px; padding-top: 10px;">üí® Cardio Progress</h4>';
            
            Object.entries(cardioByType).forEach(([type, sessions]) => {
                const recentSessions = sessions.slice(0, 5).reverse();
                const avgDuration = sessions.reduce((sum, s) => sum + s.duration, 0) / sessions.length;
                const totalDistance = sessions.reduce((sum, s) => sum + (s.distance || 0), 0);
                const avgPace = sessions.filter(s => s.distance).length > 0 
                    ? sessions.filter(s => s.distance).reduce((sum, s) => sum + (s.duration / s.distance), 0) / sessions.filter(s => s.distance).length 
                    : null;
                
                html += `
                    <div style="background: rgba(59, 130, 246, 0.1); padding: 12px; border-radius: 8px; margin-bottom: 12px; border: 1px solid rgba(59, 130, 246, 0.3);">
                        <div style="font-weight: 600; color: #60a5fa; margin-bottom: 8px; font-size: 15px;">${type}</div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 10px; font-size: 12px;">
                            <div style="text-align: center; background: rgba(0,0,0,0.2); padding: 6px; border-radius: 4px;">
                                <div style="font-size: 16px; font-weight: bold; color: #60a5fa;">${sessions.length}</div>
                                <div style="opacity: 0.7; font-size: 11px;">Sessions</div>
                            </div>
                            <div style="text-align: center; background: rgba(0,0,0,0.2); padding: 6px; border-radius: 4px;">
                                <div style="font-size: 16px; font-weight: bold; color: #60a5fa;">${avgDuration.toFixed(0)}</div>
                                <div style="opacity: 0.7; font-size: 11px;">Avg Min</div>
                            </div>
                            ${totalDistance > 0 ? `
                            <div style="text-align: center; background: rgba(0,0,0,0.2); padding: 6px; border-radius: 4px;">
                                <div style="font-size: 16px; font-weight: bold; color: #60a5fa;">${totalDistance.toFixed(1)}</div>
                                <div style="opacity: 0.7; font-size: 11px;">Total Mi</div>
                            </div>
                            ` : '<div></div>'}
                        </div>
                        ${avgPace ? `<div style="font-size: 12px; opacity: 0.8; margin-bottom: 6px;">‚ö° Avg Pace: ${avgPace.toFixed(1)} min/mi</div>` : ''}
                        <div style="font-size: 11px; opacity: 0.7; margin-bottom: 4px;">Recent Sessions:</div>
                        <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                            ${recentSessions.map(s => {
                                const sessionDate = new Date(s.date);
                                const distanceText = s.distance ? ` - ${s.distance}mi` : '';
                                return `<div style="background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 4px; font-size: 11px;">
                                    ${sessionDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}: ${s.duration}min${distanceText}
                                </div>`;
                            }).join('')}
                        </div>
                    </div>
                `;
            });
            
            html += '<hr style="border: none; border-top: 1px solid rgba(255,255,255,0.1); margin: 20px 0;">';
        }
        
        if (history.length === 0) {
            content.innerHTML = html + '<p style="text-align: center; opacity: 0.7;">Complete workouts to see progress!</p>';
            return;
        }
        
        html += '<h4 style="color: #10b981; margin-bottom: 10px;">üí™ Strength Progress</h4>';
        content.innerHTML = html; // Set the HTML with cardio section
        
        // Calculate 1RM using Epley formula: weight √ó (1 + reps/30)
        function calculate1RM(weight, reps) {
            if (reps === 0 || weight === 0) return 0;
            if (reps === 1) return weight;
            return weight * (1 + reps / 30);
        }
        
        // Collect all exercise data points with 1RM calculations
        const exerciseData = {};
        const muscleGroupData = {};
        
        history.forEach(workout => {
            const workoutDate = new Date(workout.date);
            
            workout.exercises?.forEach(ex => {
                // Initialize exercise tracking
                if (!exerciseData[ex.name]) {
                    exerciseData[ex.name] = {
                        name: ex.name,
                        isBodyweight: ex.isBodyweight,
                        muscleGroups: ex.muscleGroups || [],
                        dataPoints: []
                    };
                }
                
                // Find best set (highest 1RM) in this workout for this exercise
                let best1RM = 0;
                let bestWeight = 0;
                let bestReps = 0;
                
                ex.sets?.forEach(set => {
                    const weight = parseFloat(set.actualWeight || set.weight || 0);
                    const reps = parseFloat(set.reps || 0);
                    const estimated1RM = calculate1RM(weight, reps);
                    
                    if (estimated1RM > best1RM) {
                        best1RM = estimated1RM;
                        bestWeight = weight;
                        bestReps = reps;
                    }
                });
                
                if (best1RM > 0) {
                    exerciseData[ex.name].dataPoints.push({
                        date: workoutDate,
                        oneRM: best1RM,
                        weight: bestWeight,
                        reps: bestReps
                    });
                    
                    // Add to muscle group data
                    (ex.muscleGroups || []).forEach(muscle => {
                        if (!muscleGroupData[muscle]) {
                            muscleGroupData[muscle] = [];
                        }
                        muscleGroupData[muscle].push({
                            exercise: ex.name,
                            date: workoutDate,
                            oneRM: best1RM,
                            isBodyweight: ex.isBodyweight
                        });
                    });
                }
            });
        });
        
        // Calculate overall stats
        const totalWorkouts = history.length;
        const totalSets = history.reduce((sum, w) => {
            return sum + (w.exercises?.reduce((exSum, ex) => exSum + (ex.sets?.length || 0), 0) || 0);
        }, 0);
        
        // Calculate average workout duration
        const workoutsWithDuration = history.filter(w => w.duration > 0);
        const avgDuration = workoutsWithDuration.length > 0 
            ? Math.round(workoutsWithDuration.reduce((sum, w) => sum + w.duration, 0) / workoutsWithDuration.length)
            : 0;
        
        // Calculate workout frequency (last 30 days)
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        const recentWorkouts = history.filter(w => new Date(w.date) >= thirtyDaysAgo);
        const workoutsPerWeek = (recentWorkouts.length / 30 * 7).toFixed(1);
        
        // Sort exercises by most frequently performed
        const sortedExercises = Object.values(exerciseData)
            .filter(ex => ex.dataPoints.length > 0)
            .sort((a, b) => b.dataPoints.length - a.dataPoints.length);
        
        // Generate muscle group scatterplots
        const muscleGroupCharts = Object.entries(muscleGroupData)
            .sort(([a], [b]) => a.localeCompare(b))
            .map(([muscle, exercises]) => {
                // Group by exercise name
                const exercisesByName = {};
                exercises.forEach(ex => {
                    if (!exercisesByName[ex.exercise]) {
                        exercisesByName[ex.exercise] = [];
                    }
                    exercisesByName[ex.exercise].push(ex);
                });
                
                // Sort each exercise's data points by date
                Object.values(exercisesByName).forEach(points => {
                    points.sort((a, b) => a.date - b.date);
                });
                
                // Find min/max dates for X axis
                const allDates = exercises.map(e => e.date.getTime());
                const minDate = Math.min(...allDates);
                const maxDate = Math.max(...allDates);
                const dateRange = maxDate - minDate || 1;
                
                // Find min/max 1RM for Y axis
                const all1RMs = exercises.map(e => e.oneRM);
                const min1RM = Math.min(...all1RMs);
                const max1RM = Math.max(...all1RMs);
                const rmRange = max1RM - min1RM || 1;
                
                // Generate unique color for each exercise
                const colors = ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316'];
                const exerciseColors = {};
                Object.keys(exercisesByName).forEach((name, idx) => {
                    exerciseColors[name] = colors[idx % colors.length];
                });
                
                return `
                    <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                        <h5 style="color: #10b981; margin-bottom: 10px; font-size: 14px;">üí™ ${muscle}</h5>
                        
                        <!-- SVG Scatterplot -->
                        <svg width="100%" height="200" viewBox="0 0 400 200" style="background: rgba(0,0,0,0.2); border-radius: 6px;">
                            <!-- Grid lines -->
                            ${[0, 25, 50, 75, 100].map(pct => `
                                <line x1="40" y1="${180 - (pct * 1.4)}" x2="390" y2="${180 - (pct * 1.4)}" 
                                      stroke="rgba(255,255,255,0.1)" stroke-width="1"/>
                            `).join('')}
                            
                            <!-- Y axis labels -->
                            ${[0, 25, 50, 75, 100].map(pct => {
                                const value = min1RM + (rmRange * pct / 100);
                                return `
                                    <text x="35" y="${185 - (pct * 1.4)}" fill="rgba(255,255,255,0.5)" 
                                          font-size="10" text-anchor="end">${Math.round(value)}</text>
                                `;
                            }).join('')}
                            
                            <!-- Data points and lines -->
                            ${Object.entries(exercisesByName).map(([exName, points]) => {
                                const color = exerciseColors[exName];
                                const pointsData = points.map(point => {
                                    const x = 40 + ((point.date.getTime() - minDate) / dateRange) * 350;
                                    const y = 180 - ((point.oneRM - min1RM) / rmRange) * 140;
                                    return { x, y, oneRM: point.oneRM };
                                });
                                
                                // Draw connecting lines
                                const lineSegments = pointsData.slice(0, -1).map((point, idx) => {
                                    const next = pointsData[idx + 1];
                                    return `<line x1="${point.x}" y1="${point.y}" x2="${next.x}" y2="${next.y}" 
                                                  stroke="${color}" stroke-width="2" opacity="0.6"/>`;
                                }).join('');
                                
                                // Draw points
                                const circles = pointsData.map(point => 
                                    `<circle cx="${point.x}" cy="${point.y}" r="4" fill="${color}">
                                        <title>${exName}: ${Math.round(point.oneRM)} lbs (est. 1RM)</title>
                                    </circle>`
                                ).join('');
                                
                                return lineSegments + circles;
                            }).join('')}
                            
                            <!-- Axes -->
                            <line x1="40" y1="180" x2="390" y2="180" stroke="rgba(255,255,255,0.3)" stroke-width="2"/>
                            <line x1="40" y1="40" x2="40" y2="180" stroke="rgba(255,255,255,0.3)" stroke-width="2"/>
                            
                            <!-- Axis labels -->
                            <text x="215" y="198" fill="rgba(255,255,255,0.5)" font-size="11" text-anchor="middle">Time ‚Üí</text>
                            <text x="15" y="110" fill="rgba(255,255,255,0.5)" font-size="11" text-anchor="middle" 
                                  transform="rotate(-90, 15, 110)">Est. 1RM (lbs)</text>
                        </svg>
                        
                        <!-- Legend -->
                        <div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 8px; font-size: 11px;">
                            ${Object.entries(exercisesByName).map(([exName, points]) => {
                                const color = exerciseColors[exName];
                                const first1RM = points[0].oneRM;
                                const last1RM = points[points.length - 1].oneRM;
                                const change = last1RM - first1RM;
                                const changePercent = ((change / first1RM) * 100).toFixed(0);
                                
                                return `
                                    <div style="display: flex; align-items: center; gap: 4px; background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 12px;">
                                        <div style="width: 8px; height: 8px; border-radius: 50%; background: ${color};"></div>
                                        <span>${exName}</span>
                                        ${points.length > 1 ? `
                                            <span style="color: ${change >= 0 ? '#10b981' : '#ef4444'}; font-weight: 600;">
                                                ${change >= 0 ? '+' : ''}${changePercent}%
                                            </span>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        
        const weightsHTML = `
            <!-- Overall Stats -->
            <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                <h4 style="color: #10b981; margin-bottom: 10px; font-size: 15px;">üìä Overall Stats</h4>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                    <div style="text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: #10b981;">${totalWorkouts}</div>
                        <div style="font-size: 11px; opacity: 0.8;">Total Workouts</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: #10b981;">${totalSets}</div>
                        <div style="font-size: 11px; opacity: 0.8;">Total Sets</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: #10b981;">${workoutsPerWeek}</div>
                        <div style="font-size: 11px; opacity: 0.8;">Workouts/Week (30d)</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: #10b981;">${avgDuration || '-'}</div>
                        <div style="font-size: 11px; opacity: 0.8;">Avg Duration (min)</div>
                    </div>
                </div>
            </div>
            
            <!-- Exercise Personal Records -->
            <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                <h4 style="color: #3b82f6; margin-bottom: 10px; font-size: 15px;">üí™ Personal Records (Estimated 1RM)</h4>
                <div style="max-height: 400px; overflow-y: auto;">
                    ${sortedExercises.slice(0, 10).map(ex => {
                        const sortedPoints = ex.dataPoints.sort((a, b) => b.date - a.date);
                        const latest = sortedPoints[0];
                        const oldest = sortedPoints[sortedPoints.length - 1];
                        const max1RM = Math.max(...ex.dataPoints.map(p => p.oneRM));
                        const change1RM = latest.oneRM - oldest.oneRM;
                        const changePercent = ((change1RM / oldest.oneRM) * 100).toFixed(0);
                        const trend = change1RM > 0 ? 'üìà' : change1RM < 0 ? 'üìâ' : '‚û°Ô∏è';
                        
                        return `
                            <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; margin-bottom: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                                    <div>
                                        <div style="font-weight: 600; color: #3b82f6; font-size: 13px;">${ex.name}</div>
                                        <div style="font-size: 11px; opacity: 0.7;">Performed ${ex.dataPoints.length} time${ex.dataPoints.length > 1 ? 's' : ''}</div>
                                    </div>
                                    <div style="font-size: 18px;">${trend}</div>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; font-size: 12px;">
                                    <div>
                                        <div style="opacity: 0.7;">Max 1RM</div>
                                        <div style="font-weight: 600; color: #10b981;">${Math.round(max1RM)} lbs</div>
                                    </div>
                                    <div>
                                        <div style="opacity: 0.7;">Latest</div>
                                        <div style="font-weight: 600;">${Math.round(latest.weight)}√ó${latest.reps}</div>
                                    </div>
                                    ${ex.dataPoints.length > 1 ? `
                                    <div>
                                        <div style="opacity: 0.7;">Progress</div>
                                        <div style="font-weight: 600; color: ${change1RM >= 0 ? '#10b981' : '#ef4444'};">
                                            ${change1RM >= 0 ? '+' : ''}${changePercent}%
                                        </div>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
            
            <!-- Muscle Group Progress Charts -->
            <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                <h4 style="color: #f59e0b; margin-bottom: 10px; font-size: 15px;">üìà Strength Progress by Muscle Group</h4>
                <div style="font-size: 11px; opacity: 0.7; margin-bottom: 10px; font-style: italic;">
                    Using Epley formula to estimate 1RM from your best set each workout. Hover over points to see details.
                </div>
                ${muscleGroupCharts}
            </div>
        `;
        
        // Append weights progress to cardio HTML
        content.innerHTML += weightsHTML;
    }
    
    // Custom Exercise Management
    let editingCustomExerciseId = null;
    let allEquipmentOptions = [];
    
    // Exercise name autocomplete functions
    function showExerciseNameDropdown() {
        filterExerciseNames();
    }
    window.showExerciseNameDropdown = showExerciseNameDropdown;
    
    function filterExerciseNames() {
        const input = document.getElementById('customExerciseName');
        const dropdown = document.getElementById('exerciseNameDropdown');
        const searchTerm = input.value.toLowerCase().trim();
        
        // Get all existing exercise names
        const existingNames = Object.keys(exerciseDB).sort();
        
        // Filter by search term
        const filtered = existingNames.filter(name => 
            name.toLowerCase().includes(searchTerm)
        );
        
        // Don't show dropdown if empty search, no results, or exact match
        if (!searchTerm || filtered.length === 0 || 
            (filtered.length === 1 && filtered[0].toLowerCase() === searchTerm)) {
            dropdown.classList.add('hidden');
            return;
        }
        
        // Show matching exercises with warning styling
        dropdown.innerHTML = filtered.slice(0, 10).map(name => {
            const isCustom = exerciseDB[name].isCustom;
            const badge = isCustom ? '<span style="font-size: 10px; padding: 2px 6px; border-radius: 10px; background: rgba(59, 130, 246, 0.3); color: #93c5fd; margin-left: 6px;">Custom</span>' : '';
            
            return `
                <div style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); background: rgba(239, 68, 68, 0.1); border-left: 3px solid #ef4444;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #fca5a5;">‚ö†Ô∏è Already exists: ${name}${badge}</span>
                    </div>
                    <div style="font-size: 11px; opacity: 0.7; margin-top: 2px;">
                        ${exerciseDB[name].muscleGroups?.join(', ') || 'No muscle groups'}
                    </div>
                </div>
            `;
        }).join('');
        
        dropdown.classList.remove('hidden');
    }
    window.filterExerciseNames = filterExerciseNames;
    
    // Equipment dropdown functions
    function initializeEquipmentOptions() {
        // Get all unique equipment from exerciseDB
        const equipmentSet = new Set();
        Object.values(exerciseDB).forEach(ex => {
            if (ex.equipmentVariations) {
                ex.equipmentVariations.forEach(eq => equipmentSet.add(eq));
            }
        });
        allEquipmentOptions = Array.from(equipmentSet).sort();
    }
    
    function showEquipmentDropdown() {
        if (allEquipmentOptions.length === 0) {
            initializeEquipmentOptions();
        }
        filterEquipmentOptions();
    }
    window.showEquipmentDropdown = showEquipmentDropdown;
    
    function filterEquipmentOptions() {
        const input = document.getElementById('customExerciseEquipment');
        const dropdown = document.getElementById('equipmentDropdown');
        const searchTerm = input.value.toLowerCase();
        
        const filtered = allEquipmentOptions.filter(eq => 
            eq.toLowerCase().includes(searchTerm)
        );
        
        if (filtered.length === 0 || (searchTerm && filtered.length === 1 && filtered[0].toLowerCase() === searchTerm)) {
            dropdown.classList.add('hidden');
            return;
        }
        
        dropdown.innerHTML = filtered.slice(0, 10).map(eq => `
            <div onclick="selectEquipment('${eq.replace(/'/g, "\\'")}'); event.stopPropagation();" 
                 style="padding: 10px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.1);"
                 onmouseover="this.style.background='rgba(255,255,255,0.1)'"
                 onmouseout="this.style.background='transparent'">
                ${eq}
            </div>
        `).join('');
        
        dropdown.classList.remove('hidden');
    }
    window.filterEquipmentOptions = filterEquipmentOptions;
    
    function selectEquipment(equipment) {
        document.getElementById('customExerciseEquipment').value = equipment;
        document.getElementById('equipmentDropdown').classList.add('hidden');
    }
    window.selectEquipment = selectEquipment;
    
    // Hide dropdowns when clicking outside
    document.addEventListener('click', function(e) {
        const equipmentDropdown = document.getElementById('equipmentDropdown');
        const equipmentInput = document.getElementById('customExerciseEquipment');
        if (equipmentDropdown && equipmentInput && e.target !== equipmentInput && !equipmentDropdown.contains(e.target)) {
            equipmentDropdown.classList.add('hidden');
        }
        
        const nameDropdown = document.getElementById('exerciseNameDropdown');
        const nameInput = document.getElementById('customExerciseName');
        if (nameDropdown && nameInput && e.target !== nameInput && !nameDropdown.contains(e.target)) {
            nameDropdown.classList.add('hidden');
        }
    });
    
    function showCustomExerciseManager() {
        document.getElementById('customExerciseModal').classList.remove('hidden');
        document.getElementById('customExerciseForm').classList.add('hidden');
        editingCustomExerciseId = null;
        renderCustomExercisesList();
    }
    window.showCustomExerciseManager = showCustomExerciseManager;
    
    function hideCustomExerciseManager() {
        document.getElementById('customExerciseModal').classList.add('hidden');
        document.getElementById('customExerciseForm').classList.add('hidden');
        editingCustomExerciseId = null;
    }
    window.hideCustomExerciseManager = hideCustomExerciseManager;
    
    function showCreateCustomExercise() {
        // Open the modal first
        document.getElementById('customExerciseModal').classList.remove('hidden');
        
        editingCustomExerciseId = null;
        document.getElementById('customFormTitle').textContent = 'Create Custom Exercise';
        document.getElementById('customExerciseForm').classList.remove('hidden');
        
        // Hide the custom exercises list while creating
        document.getElementById('customExercisesList').classList.add('hidden');
        
        // Clear form
        document.getElementById('customExerciseName').value = '';
        document.getElementById('customExerciseEquipment').value = '';
        document.getElementById('customExerciseDescription').value = '';
        document.getElementById('customExerciseDifficulty').value = 'beginner';
        document.getElementById('customExerciseIsBodyweight').checked = false;
        document.querySelectorAll('.custom-muscle-checkbox').forEach(cb => cb.checked = false);
        
        // Hide dropdowns
        document.getElementById('exerciseNameDropdown').classList.add('hidden');
        document.getElementById('equipmentDropdown').classList.add('hidden');
    }
    window.showCreateCustomExercise = showCreateCustomExercise;
    
    function editCustomExercise(exerciseName) {
        const exercise = appData.customExercises[exerciseName];
        if (!exercise) return;
        
        editingCustomExerciseId = exerciseName;
        document.getElementById('customFormTitle').textContent = 'Edit Custom Exercise';
        document.getElementById('customExerciseForm').classList.remove('hidden');
        
        // Hide the custom exercises list while editing
        document.getElementById('customExercisesList').classList.add('hidden');
        
        // Fill form with existing data
        document.getElementById('customExerciseName').value = exerciseName;
        document.getElementById('customExerciseEquipment').value = exercise.equipment || '';
        document.getElementById('customExerciseDescription').value = exercise.description || '';
        document.getElementById('customExerciseDifficulty').value = exercise.difficulty || 'beginner';
        document.getElementById('customExerciseIsBodyweight').checked = exercise.isBodyweight || false;
        
        // Set muscle groups
        document.querySelectorAll('.custom-muscle-checkbox').forEach(cb => {
            cb.checked = (exercise.muscleGroups || []).includes(cb.value);
        });
    }
    window.editCustomExercise = editCustomExercise;
    
    function saveCustomExercise() {
        const name = document.getElementById('customExerciseName').value.trim();
        const equipment = document.getElementById('customExerciseEquipment').value.trim();
        const description = document.getElementById('customExerciseDescription').value.trim();
        const difficulty = document.getElementById('customExerciseDifficulty').value;
        const isBodyweight = document.getElementById('customExerciseIsBodyweight').checked;
        
        if (!name) {
            alert('Please enter an exercise name!');
            return;
        }
        
        if (!equipment) {
            alert('Please enter equipment needed!');
            return;
        }
        
        const selectedMuscles = Array.from(document.querySelectorAll('.custom-muscle-checkbox:checked'))
            .map(cb => cb.value);
        
        if (selectedMuscles.length === 0) {
            alert('Please select at least one muscle group!');
            return;
        }
        
        // Check if renaming and name already exists
        if (editingCustomExerciseId && editingCustomExerciseId !== name) {
            if (exerciseDB[name]) {
                alert('An exercise with this name already exists!');
                return;
            }
            // Delete old entry
            delete appData.customExercises[editingCustomExerciseId];
            delete exerciseDB[editingCustomExerciseId];
        } else if (!editingCustomExerciseId && exerciseDB[name]) {
            alert('An exercise with this name already exists!');
            return;
        }
        
        const exercise = {
            muscleGroups: selectedMuscles,
            muscleGroup: selectedMuscles[0], // For compatibility
            equipment: equipment,
            description: description,
            difficulty: difficulty,
            isBodyweight: isBodyweight,
            isCustom: true,
            equipmentVariations: [equipment]
        };
        
        appData.customExercises[name] = exercise;
        exerciseDB[name] = exercise;
        saveData();
        
        document.getElementById('customExerciseForm').classList.add('hidden');
        document.getElementById('customExercisesList').classList.remove('hidden');
        renderCustomExercisesList();
        
        // Refresh the exercise search if we're on the workout tab
        if (!document.getElementById('workoutTab').classList.contains('hidden')) {
            searchExercises();
        }
    }
    window.saveCustomExercise = saveCustomExercise;
    
    function cancelCustomExerciseForm() {
        document.getElementById('customExerciseForm').classList.add('hidden');
        document.getElementById('customExercisesList').classList.remove('hidden');
        editingCustomExerciseId = null;
    }
    window.cancelCustomExerciseForm = cancelCustomExerciseForm;
    
    function deleteCustomExercise(exerciseName) {
        if (!confirm(`Delete "${exerciseName}"? This cannot be undone.`)) return;
        
        delete appData.customExercises[exerciseName];
        delete exerciseDB[exerciseName];
        saveData();
        
        renderCustomExercisesList();
        
        // Refresh the exercise search if we're on the workout tab
        if (!document.getElementById('workoutTab').classList.contains('hidden')) {
            searchExercises();
        }
    }
    window.deleteCustomExercise = deleteCustomExercise;
    
    function renderCustomExercisesList() {
        const container = document.getElementById('customExercisesList');
        const customExercises = Object.entries(appData.customExercises || {});
        
        if (customExercises.length === 0) {
            container.innerHTML = '<p style="text-align: center; opacity: 0.7; margin: 15px 0;">No custom exercises yet. Create your first one!</p>';
            return;
        }
        
        container.innerHTML = '<h3 style="color: #10b981; margin-bottom: 10px; font-size: 16px;">Your Custom Exercises</h3>' +
            customExercises.map(([name, ex]) => {
                const muscleText = ex.muscleGroups ? ex.muscleGroups.join(', ') : 'No muscle groups';
                const difficultyColor = {
                    'beginner': '#10b981',
                    'intermediate': '#f59e0b',
                    'advanced': '#ef4444'
                }[ex.difficulty] || '#6b7280';
                
                return `
                    <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #10b981; margin-bottom: 4px;">
                                    ${name}
                                    <span style="font-size: 10px; padding: 2px 6px; border-radius: 10px; background: rgba(255,255,255,0.1); color: ${difficultyColor}; margin-left: 6px;">
                                        ${ex.difficulty}
                                    </span>
                                    ${ex.isBodyweight ? '<span style="font-size: 10px; padding: 2px 6px; border-radius: 10px; background: rgba(16, 185, 129, 0.2); color: #10b981; margin-left: 6px;">Bodyweight</span>' : ''}
                                </div>
                                <div style="font-size: 12px; opacity: 0.8; margin-bottom: 2px;">
                                    üîß ${ex.equipment}
                                </div>
                                <div style="font-size: 12px; opacity: 0.7;">
                                    üí™ ${muscleText}
                                </div>
                                ${ex.description ? `<div style="font-size: 11px; opacity: 0.6; margin-top: 4px; font-style: italic;">${ex.description}</div>` : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 6px; margin-top: 8px;">
                            <button class="action-btn primary" onclick="editCustomExercise('${name.replace(/'/g, "\\'")}')">Edit</button>
                            <button class="action-btn danger" onclick="deleteCustomExercise('${name.replace(/'/g, "\\'")}')">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
    }
    
    function showSettings() {
        const content = document.getElementById('settingsContent');
        const currentBW = appData.settings?.bodyWeight || '';
        
        content.innerHTML = `
            <h3 style="color: #10b981; margin-bottom: 10px;">Body Weight</h3>
            <div style="background: rgba(16, 185, 129, 0.1); padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 12px;">
                <strong>üí° Important:</strong> Your bodyweight is saved with each workout for accurate tracking of bodyweight exercises like pull-ups, push-ups, and dips. Update this when your weight changes!
            </div>
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <input type="number" id="bw" placeholder="Weight (lbs)" class="exercise-input" 
                       style="max-width: 150px; margin: 0;" value="${currentBW}" step="0.1">
                <button class="action-btn success" id="saveBwBtn">Save</button>
            </div>
            ${currentBW ? `<div style="font-size: 12px; opacity: 0.7; margin-bottom: 20px;">Current: ${currentBW} lbs</div>` : ''}
            
            <h3 style="color: #10b981; margin-bottom: 10px;">Data Management</h3>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="action-btn primary" id="exportBtn">Export</button>
                <button class="action-btn primary" id="importBtn">Import</button>
                <button class="action-btn danger" id="clearBtn">Clear All</button>
            </div>
            <input type="file" id="importFile" accept=".json" style="display: none;">
        `;
        
        document.getElementById('saveBwBtn').addEventListener('click', () => {
            const newBW = document.getElementById('bw').value;
            if (!newBW || parseFloat(newBW) <= 0) {
                alert('Please enter a valid bodyweight!');
                return;
            }
            if (!appData.settings) appData.settings = {};
            appData.settings.bodyWeight = newBW;
            saveData();
            showSettings(); // Refresh to show current weight
        });
        
        document.getElementById('exportBtn').addEventListener('click', () => {
            const dataStr = JSON.stringify(appData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `for-lifters-only-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        });
        
        document.getElementById('importBtn').addEventListener('click', () => {
            document.getElementById('importFile').click();
        });
        
        document.getElementById('importFile').addEventListener('change', function() {
            const file = this.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (confirm('Replace all data?')) {
                        appData = imported;
                        saveData();
                        location.reload();
                    }
                } catch (error) {
                    alert('Import failed');
                }
            };
            reader.readAsText(file);
            this.value = '';
        });
        
        document.getElementById('clearBtn').addEventListener('click', () => {
            if (confirm('Delete ALL data?\n\nThis includes workouts, history, and custom exercises.')) {
                const keepCustom = confirm('Keep your custom exercises?\n\n- Click OK to keep custom exercises\n- Click Cancel to delete everything');
                
                if (keepCustom) {
                    const savedCustom = appData.customExercises;
                    const savedBW = appData.settings?.bodyWeight;
                    appData = { workouts: {}, history: {}, settings: {}, activeWorkout: {}, customExercises: savedCustom };
                    if (savedBW) appData.settings.bodyWeight = savedBW;
                } else {
                    appData = { workouts: {}, history: {}, settings: {}, activeWorkout: {}, customExercises: {} };
                }
                
                saveData();
                location.reload();
            }
        });
    }
    
    // Start the app
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
    
    // Register Service Worker for PWA
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('service-worker.js')
                .then(registration => {
                    console.log('Service Worker registered:', registration.scope);
                })
                .catch(error => {
                    console.log('Service Worker registration failed:', error);
                });
        });
    }
})();
    </script>
</body>
</html>
